<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì œì£¼ì—¬í–‰ AI : í”Œë˜ë„ˆ</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;600;700;800;900&display=swap');
        body { font-family: 'Pretendard', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #F8FAFC; margin: 0; padding: 0; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.4s ease-out forwards; }
        
        .active-card { background-color: #FEF2F2 !important; animation: pulse-border 2s infinite; border-width: 2px; }
        @keyframes pulse-border {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); border-color: #EF4444; }
            70% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); border-color: #F87171; }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); border-color: #EF4444; }
        }
        .stamped-card { background-color: #FFFBEB !important; border-color: #F59E0B !important; border-width: 2px; }
        @keyframes stamp-bounce { 0% { transform: scale(2); opacity: 0; } 60% { transform: scale(0.9); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
        .stamp-mark { animation: stamp-bounce 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes progress-shim { 0% { background-position: -100% 0; } 100% { background-position: 100% 0; } }
        .progress-bar-animated { background: linear-gradient(90deg, #0D9488 0%, #2DD4BF 50%, #0D9488 100%); background-size: 200% 100%; animation: progress-shim 2s linear infinite; }
        
        .leaflet-popup-content-wrapper { border-radius: 8px; padding: 0; box-shadow: 0 4px 15px rgba(0,0,0,0.15); }
        .leaflet-popup-content { font-family: 'Pretendard', sans-serif; font-size: 13px; font-weight: 800; margin: 8px 12px; color: #0F766E; }
        .leaflet-container a.leaflet-popup-close-button { display: none; } 

        /* Custom Map Marker Badge */
        .map-marker-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            font-weight: 800;
            font-size: 12px;
            color: white;
        }

        @media print {
            @page { margin: 1cm; size: A4; }
            body { background-color: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            .schedule-container { margin-top: 0 !important; box-shadow: none !important; border: none !important; padding-bottom: 0 !important; }
            .timeline-item { break-inside: avoid; page-break-inside: avoid; border-bottom: 1px solid #eee; padding-bottom: 20px; margin-bottom: 20px; }
            .timeline-line { display: none !important; }
            .timeline-time { width: auto !important; font-size: 1.2em !important; color: #0F766E !important; margin-bottom: 5px; }
            .timeline-content { padding-left: 0 !important; border: 1px solid #ddd !important; border-radius: 8px !important; box-shadow: none !important; }
            textarea { border: none !important; resize: none; height: auto; background: transparent !important; overflow: hidden; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        
        const urlParams1 = new URLSearchParams(window.location.search);
        const Datekey = urlParams1.get('dt');
        let TEST_DATE_STRING = null; 
        if (Datekey && Datekey.length >= 10) {
            TEST_DATE_STRING = `${Datekey.substring(0,4)}-${Datekey.substring(4,6)}-${Datekey.substring(6,8)}T${Datekey.substring(8,10)}:${Datekey.substring(10,12)}:00`;
        } else if (Datekey && Datekey.length >= 8) {
             TEST_DATE_STRING = Datekey;
        }

        // =========================================
        // 1. ê³µí†µ ì»´í¬ë„ŒíŠ¸
        // =========================================
        const Icon = ({ name, size = 24, className = "", ...props }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (window.lucide && iconRef.current && iconRef.current.parentNode) {
                    window.lucide.createIcons({ root: iconRef.current.parentNode, nameAttr: 'data-lucide', attrs: { width: size, height: size, class: className, ...props } });
                }
            }, [name, size, className]);
            return <i ref={iconRef} data-lucide={name} style={{ width: size, height: size, display: 'inline-block' }} className={className} {...props}></i>;
        };

        const Toast = ({ message, onClose }) => {
			useEffect(() => { const timer = setTimeout(onClose, 3000); return () => clearTimeout(timer); }, []);
			return (
				<div className="fixed bottom-24 left-5 z-[3000] flex items-center gap-3 bg-slate-800/95 backdrop-blur-md text-white px-5 py-3 rounded-2xl text-sm font-bold shadow-2xl animate-fadeIn max-w-[85%] no-print">
					<Icon name="bell" size={20} className="text-teal-400 flex-shrink-0" />
					<span className="leading-snug">{message}</span>
				</div>
			);
		};

        const NavBtn = ({ active, onClick, icon, label }) => (
            <div onClick={onClick} className={`text-center w-1/4 cursor-pointer transition-colors ${active ? 'text-teal-700 font-extrabold' : 'text-slate-400 font-normal'}`}>
                <div className="block mb-1 mx-auto w-fit">
                    <Icon name={icon} size={24} strokeWidth={active ? 2.8 : 2} />
                </div>
                <span className="text-[10px] block">{label}</span>
            </div>
        );

        // =========================================
        // 2. ì±—ë´‡ ì»´í¬ë„ŒíŠ¸ (ë¹„ìš© ì—°ë™ ê¸°ëŠ¥ ê°•í™”)
        // =========================================
        const ChatWidget = ({ onClose, schedule, places, costs, onUpdateSchedule, onResetSchedule, currentTime }) => {
            const getInitialMessage = () => {
                return 'ì•ˆë…•í•˜ì„¸ìš”! AI ì œì£¼ ê°€ì´ë“œì…ë‹ˆë‹¤. ğŸŠ\n\nì¼ì •ì„ ë³€ê²½í•˜ê±°ë‚˜ ë§›ì§‘ì„ ì¶”ì²œí•´ë“œë¦´ ìˆ˜ ìˆì–´ìš”. "ì ì‹¬ ì¥ì†Œ ë³€ê²½í•´ì¤˜"ë¼ê³  ë§í•´ë³´ì„¸ìš”!';
            };

            const [messages, setMessages] = useState([{ role: 'bot', text: getInitialMessage() }]);
            const [input, setInput] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [dynamicApiKey, setDynamicApiKey] = useState("");
            const [userLocation, setUserLocation] = useState(null); 
            const [pendingUpdates, setPendingUpdates] = useState(null);
            const messagesEndRef = useRef(null);

            useEffect(() => messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }), [messages]);

            useEffect(() => {
                const detectLocation = () => {
                    let estimatedLoc = { lat: 33.5104, lng: 126.4913, name: "ì œì£¼ê³µí•­" }; 
                    let currentItem = null;
                    const now = currentTime || new Date();
                    for (let i = schedule.length - 1; i >= 0; i--) {
                        const item = schedule[i];
                        const itemDate = getItemDate(item.day, item.time);
                        if (itemDate && itemDate <= now && item.lat) {
                            currentItem = item;
                            break;
                        }
                    }
                    if (currentItem) {
                        estimatedLoc = { lat: currentItem.lat, lng: currentItem.lng, name: currentItem.title };
                    }

                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(
                            (position) => {
                                const { latitude, longitude } = position.coords;
                                let nearestName = "í˜„ìœ„ì¹˜";
                                let minD = 9999;
                                [...schedule, ...places].forEach(p => {
                                    if(p.lat) {
                                        const d = calculateDistance(latitude, longitude, p.lat, p.lng);
                                        if (d < minD) { minD = d; nearestName = p.title || p.name; }
                                    }
                                });
                                const finalName = minD < 2 ? `${nearestName} ê·¼ì²˜` : "ì œì£¼ ì–´ë”˜ê°€";
                                setUserLocation({ lat: latitude, lng: longitude, name: finalName, isGPS: true });
                            },
                            (error) => {
                                setUserLocation({ ...estimatedLoc, isGPS: false });
                            }
                        );
                    } else {
                        setUserLocation({ ...estimatedLoc, isGPS: false });
                    }
                };
                detectLocation();
            }, []);

            const sendMessage = async () => {
                if (!input.trim()) return;
                const userMsg = input;
                setMessages(prev => [...prev, { role: 'user', text: userMsg }]);
                setInput('');
                setIsLoading(true);
                setPendingUpdates(null);

                const urlParams = new URLSearchParams(window.location.search);
                let apiKey = urlParams.get('key');
                if (!apiKey) apiKey = dynamicApiKey;

                if (!apiKey || apiKey.length < 10) {
                    if (userMsg.length > 10 && userMsg.startsWith("AI")) { 
                         setDynamicApiKey(userMsg.trim()); 
                         setMessages(prev => [...prev, { role: 'bot', text: `API Key ì„¤ì • ì™„ë£Œ! ë˜‘ë˜‘í•˜ê²Œ ë„ì™€ë“œë¦´ê²Œìš” ğŸŠ` }]);
                        setIsLoading(false);
                        return;
                    } else {
                        setTimeout(() => {
                            setMessages(prev => [...prev, { role: 'bot', text: "âš ï¸ API Keyê°€ í•„ìš”í•©ë‹ˆë‹¤.\nì±„íŒ…ì°½ì— ì…ë ¥í•˜ê±°ë‚˜ URL(?key=...)ì„ í™•ì¸í•´ì£¼ì„¸ìš”." }]);
                            setIsLoading(false);
                        }, 500);
                        return;
                    }
                }

                try {
                    const contextLoc = userLocation ? `ìœ„ë„:${userLocation.lat}, ê²½ë„:${userLocation.lng} (${userLocation.name})` : "ìœ„ì¹˜ íŒŒì•… ì¤‘";
                    const contextTime = currentTime ? currentTime.toLocaleString() : new Date().toLocaleString();
                    
                    // ë¹„ìš© ë°ì´í„°ë¥¼ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜í•˜ì—¬ AIì—ê²Œ ì „ë‹¬
                    const costContext = costs.map(cat => 
                        cat.items.map(item => `${item.n} (${item.v}ì›)`).join(", ")
                    ).join(" / ");

                    const context = `
                        [ì‹œìŠ¤í…œ ì„¤ì •]
                        ë‹¹ì‹ ì€ ì œì£¼ë„ ì—¬í–‰ ì „ë¬¸ê°€ AIì…ë‹ˆë‹¤.
                        
                        [í•„ìˆ˜ ê²€ì¦ ê·œì¹™]
                        1. **ì‹¤ì¡´ ì¥ì†Œ ê²€ì¦**: ì¶”ì²œí•˜ê±°ë‚˜ ë³€ê²½í•˜ë ¤ëŠ” ì¥ì†Œê°€ ì‹¤ì œ ì œì£¼ë„ì— ì¡´ì¬í•˜ëŠ”ì§€, í˜„ì¬ ì˜ì—… ì¤‘ì¸ì§€ ê²€ì¦í•˜ì‹­ì‹œì˜¤.
                        2. **ìœ„ì¹˜ ì •í™•ì„±**: ìœ„ë„/ê²½ë„ëŠ” ë°˜ë“œì‹œ ì†Œìˆ˜ì  4ìë¦¬ ì´ìƒ ì •í™•í•´ì•¼ í•©ë‹ˆë‹¤.
                        3. **ê²½ë¹„ ì—°ë™ í•„ìˆ˜**: ì‹ë‹¹ì´ë‚˜ ìœ ë£Œ ê´€ê´‘ì§€ë¡œ ì¼ì •ì„ ë³€ê²½í•  ê²½ìš°, ë°˜ë“œì‹œ 'costUpdate' í•„ë“œë¥¼ ì±„ì›Œì•¼ í•©ë‹ˆë‹¤. ì•„ë˜ [í˜„ì¬ ê²½ë¹„ í•­ëª©]ì—ì„œ ê°€ì¥ ìœ ì‚¬í•œ í•­ëª© ì´ë¦„ì„ ì°¾ì•„ ë§¤í•‘í•˜ì‹­ì‹œì˜¤.

                        [í˜„ì¬ ì‚¬ìš©ì ìƒí™©]
                        - ì‹œê°„: ${contextTime}
                        - ìœ„ì¹˜: ${contextLoc}
                        - ì¸ì›: 3ëª… (ë¹„ìš© ê³„ì‚° ì‹œ í•„ìˆ˜)

                        [í˜„ì¬ ì¼ì • ë°ì´í„°]
                        ${schedule.map(s => `ID:${s.id} | ${s.time} | ${s.title}`).join('\n')}

                        [í˜„ì¬ ê²½ë¹„ í•­ëª© (ì¤‘ìš”)]
                        ${costContext}

                        [ì‘ë‹µ í¬ë§·]
                        ì¼ì • ë³€ê²½ì´ í•„ìš”í•œ ê²½ìš°ì—ë§Œ ì•„ë˜ JSON í¬ë§·ì„ ì‚¬ìš©í•˜ì‹­ì‹œì˜¤.
                        
                        <<<UPDATE_SCHEDULE: {
                            "updates": [
                                {
                                    "targetId": "ë³€ê²½í• _ì¼ì •_ID",
                                    "newTitle": "ìƒˆë¡œìš´ ì¥ì†Œëª…",
                                    "newDesc": "í•œì¤„ ì„¤ëª…",
                                    "newDetail": "AIì¶”ì²œì‚¬ìœ  (ì‹¤ì¡´ ì¥ì†Œ ê²€ì¦ë¨)",
                                    "newLat": 33.xxxx,
                                    "newLng": 126.xxxx,
                                    "costUpdate": { 
                                        "targetItemName": "í˜„ì¬_ê²½ë¹„_í•­ëª©_ì´ë¦„(ì •í™•íˆ)", 
                                        "newItemName": "ìƒˆí•­ëª© (3ì¸)", 
                                        "newAmount": 0 
                                    },
                                    "newPlaceInfo": { "name": "ì¥ì†Œëª…(ê´„í˜¸ì—†ìŒ)", "type": "meal/cafe/tour", "main": "...", "desc": "...", "tips": ["..."] }
                                }
                            ],
                            "replyMessage": "ë³€ê²½ ì œì•ˆ ë©”ì‹œì§€"
                        }>>>
                    `;

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: `${context}\n\nì‚¬ìš©ì ë°œí™”: ${userMsg}` }] }] })
                    });
                    const data = await response.json();
                    
                    let botMsg = data.candidates?.[0]?.content?.parts?.[0]?.text || "ì£„ì†¡í•´ìš”, ì´í•´í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
                    
                    const commandMatch = botMsg.match(/<<<UPDATE_SCHEDULE:\s*(\{[\s\S]*?\})\s*>>>/);
                    if (commandMatch) {
                        try {
                            const commandData = JSON.parse(commandMatch[1]);
                            botMsg = commandData.replyMessage || "ì¼ì • ë³€ê²½ì„ ì œì•ˆí•©ë‹ˆë‹¤.";
                            setPendingUpdates(commandData.updates);
                        } catch (e) {
                            console.error("JSON Parse Error", e);
                            botMsg += "\n(ë°ì´í„° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤)";
                        }
                        botMsg = botMsg.replace(/<<<UPDATE_SCHEDULE:[\s\S]*?>>>/, "").trim();
                    }

                    setMessages(prev => [...prev, { role: 'bot', text: botMsg }]);
                } catch (error) {
                    setMessages(prev => [...prev, { role: 'bot', text: `í†µì‹  ì˜¤ë¥˜: ${error.message}` }]);
                } finally {
                    setIsLoading(false);
                }
            };

            const confirmUpdates = () => {
                if (pendingUpdates) {
                    onUpdateSchedule(pendingUpdates);
                    setMessages(prev => [...prev, { role: 'bot', text: "âœ… ì¼ì •ì´ ë³€ê²½ë˜ê³  ê²½ë¹„ ì˜ˆì‚°ë„ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!" }]);
                    setPendingUpdates(null);
                }
            };

            const cancelUpdates = () => {
                setMessages(prev => [...prev, { role: 'bot', text: "ë³€ê²½ì„ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì¥ì†Œë¥¼ ì°¾ì•„ë“œë¦´ê¹Œìš”?" }]);
                setPendingUpdates(null);
            };

            return (
                <div className="fixed inset-0 z-[200] flex items-center justify-center bg-black/40 p-4 animate-fadeIn no-print">
                    <div className="bg-white w-full max-w-md h-[600px] rounded-2xl shadow-2xl flex flex-col overflow-hidden">
                        <div className="bg-gradient-to-r from-teal-700 to-teal-600 p-4 flex justify-between items-center text-white">
                            <div className="flex items-center gap-2 font-bold">
                                <Icon name="bot" size={18}/> 
                                <div>
                                    <div className="text-sm">AI ìŠ¤ë§ˆíŠ¸ í”Œë˜ë„ˆ</div>
                                    {userLocation && <div className="text-[10px] font-normal opacity-80 flex items-center gap-1"><Icon name="map-pin" size={10}/> {userLocation.name} ê°ì§€ë¨</div>}
                                </div>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={onResetSchedule} className="text-xs bg-red-500/80 hover:bg-red-500 px-2 py-1 rounded text-white font-bold transition-colors">ì´ˆê¸°í™” ì˜µì…˜</button>
                                <button onClick={onClose}><Icon name="x" size={24}/></button>
                            </div>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 bg-slate-50 space-y-4">
                            {messages.map((msg, idx) => (
                                <div key={idx} className={`flex flex-col ${msg.role === 'user' ? 'items-end' : 'items-start'}`}>
                                    <div className={`max-w-[85%] p-3.5 rounded-2xl text-sm leading-relaxed whitespace-pre-wrap shadow-sm ${msg.role === 'user' ? 'bg-teal-600 text-white rounded-tr-none' : 'bg-white text-slate-700 border border-slate-200 rounded-tl-none'}`}>
                                        {msg.role === 'bot' && <div className="mb-1 text-[10px] text-teal-600 font-bold flex items-center gap-1"><Icon name="sparkles" size={10}/> AI ë‹µë³€</div>}
                                        {msg.text}
                                    </div>
                                    {msg.role === 'bot' && idx === messages.length - 1 && pendingUpdates && (
                                        <div className="mt-2 w-[85%] bg-white border-2 border-teal-500 rounded-xl p-3 shadow-md animate-fadeIn">
                                            <div className="text-xs font-bold text-teal-700 mb-2 flex items-center gap-1"><Icon name="alert-circle" size={12}/> ì¼ì • ë³€ê²½ ì œì•ˆ</div>
                                            {pendingUpdates.map((u, i) => (
                                                <div key={i} className="mb-2 text-sm border-b border-slate-100 pb-2 last:border-0 last:pb-0">
                                                    <div className="text-slate-400 text-xs strike-through line-through">{schedule.find(s=>s.id === u.targetId)?.title}</div>
                                                    <div className="text-slate-800 font-bold flex items-center gap-1"><Icon name="arrow-right" size={12} className="text-teal-500"/> {u.newTitle}</div>
                                                    <div className="text-[10px] text-slate-500 mt-1">{u.newDetail}</div>
                                                    {u.costUpdate && (
                                                        <div className="mt-1 bg-orange-50 text-orange-700 p-1.5 rounded text-[10px] flex gap-1 items-center">
                                                            <Icon name="dollar-sign" size={10}/> 
                                                            <span>ì˜ˆì‚° ë³€ê²½: {u.costUpdate.newItemName} ({formatCost(u.costUpdate.newAmount)}ì›)</span>
                                                        </div>
                                                    )}
                                                </div>
                                            ))}
                                            <div className="flex gap-2 mt-2">
                                                <button onClick={cancelUpdates} className="flex-1 py-2 bg-slate-100 text-slate-600 rounded-lg text-xs font-bold hover:bg-slate-200">ì·¨ì†Œ</button>
                                                <button onClick={confirmUpdates} className="flex-1 py-2 bg-teal-600 text-white rounded-lg text-xs font-bold hover:bg-teal-700">ì ìš©í•˜ê¸°</button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            ))}
                            {isLoading && (
                                <div className="flex justify-start">
                                    <div className="bg-white p-3 rounded-2xl rounded-tl-none border border-slate-200 shadow-sm flex items-center gap-2 text-xs text-slate-500">
                                        <div className="w-2 h-2 bg-teal-500 rounded-full animate-bounce"></div>
                                        <div className="w-2 h-2 bg-teal-500 rounded-full animate-bounce delay-75"></div>
                                        <div className="w-2 h-2 bg-teal-500 rounded-full animate-bounce delay-150"></div>
                                        <span>ì‹¤ì¡´ ì¥ì†Œ ê²€ì¦ ë° ì˜ˆì‚° ê³„ì‚° ì¤‘...</span>
                                    </div>
                                </div>
                            )}
                            <div ref={messagesEndRef} />
                        </div>
                        <div className="p-3 bg-white border-t border-slate-100 flex gap-2">
                            <input type="text" className="flex-1 bg-slate-100 border-0 rounded-full px-4 py-3 text-sm focus:ring-2 focus:ring-teal-500 outline-none" placeholder="ì˜ˆ: ì ì‹¬ì„ ê³ ê¸°êµ­ìˆ˜ë¡œ ë°”ê¿”ì¤˜" value={input} onChange={(e) => setInput(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && sendMessage()} />
                            <button onClick={sendMessage} disabled={isLoading} className="bg-teal-600 text-white p-3 rounded-full hover:bg-teal-700 transition-colors disabled:opacity-50"><Icon name="send" size={18} /></button>
                        </div>
                    </div>
                </div>
            );
        };

        // =========================================
        // 3. ë§ˆìŠ¤í„° ë°ì´í„° (Master Data)
        // =========================================
        const SCHEDULE = [
            { id: 'd0-1', day: 0, time: "D-1", title: "ì—¬í–‰ ì „ë‚  ì²´í¬", desc: "ì‹ ë¶„ì¦(ì „ì›), ë©´í—ˆì¦, í…Œì´ë¸”ë§ ì•± ì¹´ë“œë“±ë¡ í™•ì¸", lat: 36.35, lng: 127.38, type: "prep", dist: "-", dur: "-" , detail: "í…Œì´ë¸”ë§ í˜ì´ ë“±ë¡ ì•ˆí•˜ë©´ ë‚´ì¼ ì—°ëˆ ì˜ˆì•½ ì‹¤íŒ¨í•¨!" },
            { id: 'd1-1', day: 1, time: "04:50", title: "ëŒ€ì „ ì§‘ ì¶œë°œ", desc: "ê°€ìŠ¤ ì ê¸ˆ í™•ì¸. ì²­ì£¼ê³µí•­ê¹Œì§€ 1ì‹œê°„.", lat: 36.3504, lng: 127.4370, type: "move", navi: "ì²­ì£¼êµ­ì œê³µí•­", dist: "45km", dur: "50ë¶„", detail: "ì œ2ì£¼ì°¨ì¥ ìœ„ì¹˜ ë¯¸ë¦¬ íŒŒì•…" },
            { id: 'd1-2', day: 1, time: "05:40", title: "ì²­ì£¼ê³µí•­ ë„ì°©", desc: "ì£¼ì°¨ í›„ 2ì¸µ ì´ë™. ë°”ì´ì˜¤ ë“±ë¡ì¤„ ì´ìš©.", lat: 36.7166, lng: 127.4991, type: "fixed", dist: "-", dur: "-" , detail: "ì‹ ë¶„ì¦ ë¯¸ë¦¬ êº¼ë‚´ë‘ê¸°" },
            { id: 'd1-3', day: 1, time: "06:10", title: "ìˆ˜ì† ë§ˆê°", desc: "ì´ìŠ¤íƒ€í•­ê³µ ZE711 (06:50 ì¶œë°œ). ëŠ¦ìœ¼ë©´ íƒ‘ìŠ¹ ë¶ˆê°€.", flightNum: "ZE711", lat: 36.7166, lng: 127.4991, type: "flight", dist: "-", dur: "-", detail: "ê¸°ë‚´ì—ì„œ ê¿€ì  ìê¸°" },
            { id: 'd1-4', day: 1, time: "08:00", title: "ì œì£¼ê³µí•­ & ì˜ì¹´", desc: "5ë²ˆ ê²Œì´íŠ¸ ê±´ë„ˆí¸ ë Œí„°ì¹´í•˜ìš°ìŠ¤ [5êµ¬ì—­ 12ë²ˆ]", lat: 33.5104, lng: 126.4913, type: "car", navi: "ì œì£¼êµ­ì œê³µí•­ë Œí„°ì¹´í•˜ìš°ìŠ¤", dist: "ë„ë³´", dur: "10ë¶„" , detail: "ì°¨ëŸ‰ ì™¸ê´€/íœ  ë™ì˜ìƒ ì´¬ì˜ í•„ìˆ˜ (EV3)" },
            { id: 'd1-5', day: 1, time: "09:00", title: "ìë§¤êµ­ìˆ˜ (ì•„ì¹¨)", desc: "ê³ ê¸°êµ­ìˆ˜. ìºì¹˜í…Œì´ë¸” ëŒ€ê¸° í™•ì¸ í•„ìˆ˜.", lat: 33.5050, lng: 126.4950, type: "meal", navi: "ìë§¤êµ­ìˆ˜ë³¸ì ", dist: "5km", dur: "15ë¶„", detail: "ìºì¹˜í…Œì´ë¸”ë¡œ ë¯¸ë¦¬ ì¤„ì„œê¸° í™•ì¸", alternatives: [{ name: "ì˜¬ë˜êµ­ìˆ˜", desc: "ìˆ˜ìš”ë¯¸ì‹íšŒ ë§›ì§‘. ê³ ê¸°êµ­ìˆ˜ ë‹¨ì¼ ë©”ë‰´. (ì£¼ì°¨ ì–´ë ¤ì›€)", navi: "ì˜¬ë˜êµ­ìˆ˜" }, { name: "ë§Œì„¸êµ­ìˆ˜", desc: "í˜„ì§€ì¸ ë§›ì§‘. ëŒ€ê¸° ì§§ê³  êµ­ë¬¼ ì§„í•¨. ì‚¼ì„±í˜ˆ ê·¼ì²˜.", navi: "ë§Œì„¸êµ­ìˆ˜" }] },
            { id: 'd1-5-1', day: 1, time: "10:20", title: "ì´í˜¸í…Œìš° í•´ë³€", desc: "ë§ ë“±ëŒ€ ì¸ìƒìƒ· ëª…ì†Œ. ê³µí•­ ê·¼ì²˜ í•„ìˆ˜ ì½”ìŠ¤.", lat: 33.4965, lng: 126.4530, type: "tour", navi: "ì´í˜¸í…Œìš°í•´ìˆ˜ìš•ì¥", dist: "3km", dur: "10ë¶„", detail: "ë¹¨ê°„ìƒ‰/í°ìƒ‰ ë§ ë“±ëŒ€ ì‚¬ì´ì—ì„œ ì‚¬ì§„ ì°ê¸°" },
            { id: 'd1-6', day: 1, time: "11:00", title: "í´ë­ë¸”ë£¨ & í’ì°¨í•´ì•ˆë„ë¡œ", desc: "ì‹ ì°½í’ì°¨í•´ì•ˆë„ë¡œ ë“œë¼ì´ë¸Œ í›„ ì¹´í˜.", lat: 33.3450, lng: 126.1700, type: "cafe", navi: "í´ë­ë¸”ë£¨", dist: "28km", dur: "45ë¶„" , detail: "í•´ì•ˆë„ë¡œ ë“œë¼ì´ë¸Œ ì½”ìŠ¤! 2ì¸µ í†µì°½ ì¸ìƒìƒ·.", isDrive: true, alternatives: [{ name: "ìš¸íŠ¸ë¼ë§ˆë¦°", desc: "íŒí¬í¬êµ¬ ë·°. ë…¸ì„ ë§›ì§‘ì´ì ì˜¤ì…˜ë·° ëíŒì™•.", navi: "ìš¸íŠ¸ë¼ë§ˆë¦°" }] },
            { 
                id: 'd1-7', day: 1, time: "12:30", title: "ì•Œëˆê°€ (ì ì‹¬)", desc: "í˜„ì§€ì¸ ì¶”ì²œ ìíˆ¬ë¦¬ ê³ ê¸° & ëŒì†¥ë°¥.", lat: 33.3146, lng: 126.2737, type: "meal", navi: "ì•Œëˆê°€", dist: "9km", dur: "18ë¶„", detail: "ì§œíˆ¬ë¦¬ ê³ ê¸°ì— ëŒì†¥ë°¥+ê¹€ì¹˜ì°Œê°œ í•„ìˆ˜",
                alternatives: [
                    { name: "ëª…ë¦¬ë™ì‹ë‹¹", desc: "ê¹€ì¹˜ì „ê³¨ê³¼ ì§œíˆ¬ë¦¬ê³ ê¸°ë¡œ ìœ ëª…í•œ ì¸ê·¼ ì°ë§›ì§‘.", navi: "ëª…ë¦¬ë™ì‹ë‹¹" },
                    { name: "ì–‘ê°€í˜•ì œ", desc: "ì²­ìˆ˜ë¦¬ í‰í™”ë™ íšŒê´€ì„ ê°œì¡°í•œ ìˆ˜ì œë²„ê±° ë§›ì§‘.", navi: "ì–‘ê°€í˜•ì œ" }
                ]
            },
            { id: 'd1-8', day: 1, time: "14:00", title: "ì†¡ì•…ì‚° ë‘˜ë ˆê¸¸", desc: "ì‹í›„ ì†Œí™” íŠ¸ë ˆí‚¹. ì ˆë²½ ë·° ì˜ˆìˆ .", lat: 33.1994, lng: 126.2908, type: "tour", navi: "ì†¡ì•…ì‚°ì£¼ì°¨ì¥", dist: "14km", dur: "25ë¶„", detail: "ë°”ëŒ ê°•í•¨! ë°”ëŒë§‰ì´ í•„ìˆ˜ ì°©ìš©", alternatives: [{ name: "ì‚°ë°©ì‚° íƒ„ì‚°ì˜¨ì²œ", desc: "ë°”ëŒ ë„ˆë¬´ ë¶ˆê±°ë‚˜ ì¶”ìš°ë©´ ì˜¨ì²œìš• ì¶”ì²œ. (ì•¼ì™¸ ë…¸ì²œíƒ•)", navi: "ì‚°ë°©ì‚°íƒ„ì‚°ì˜¨ì²œ" }] },
            { id: 'd1-9', day: 1, time: "15:30", title: "ì›ì•¤ì˜¨ë¦¬ (ì¹´í˜)", desc: "ì‚°ë°©ì‚° ë°°ì‚°ì„ìˆ˜ ë·°. ì•¼ì™¸ í…Œë¼ìŠ¤ íœ´ì‹.", lat: 33.2392, lng: 126.3195, type: "cafe", navi: "ì›ì•¤ì˜¨ë¦¬", dist: "5km", dur: "10ë¶„", detail: "ì‚¬ëŒ ë§ìœ¼ë©´ í…Œì´í¬ì•„ì›ƒ í›„ ë°”ë¡œ ì• í•´ë³€ ì‚°ì±…" },
            { id: 'd1-10', day: 1, time: "16:30", title: "ì¹´ë©œë¦¬ì•„í", desc: "11ì›” ë™ë°±ê½ƒ ì¶•ì œ. ì¼ëª° ì „ ì‚¬ì§„ ì´¬ì˜.", lat: 33.2872, lng: 126.3705, type: "tour", navi: "ì¹´ë©œë¦¬ì•„í", dist: "10km", dur: "15ë¶„", detail: "í°ìƒ‰/ë°ì€ìƒ‰ ì˜·ì´ ì‚¬ì§„ ì˜ ë‚˜ì˜´", alternatives: [{ name: "ì˜¤ì„¤ë¡ í‹° ë®¤ì§€ì—„", desc: "ë¹„ ì˜¤ê±°ë‚˜ ë„ˆë¬´ ì¶”ìš°ë©´ ì‹¤ë‚´ ì¶”ì²œ. ë…¹ì°¨ ì•„ì´ìŠ¤í¬ë¦¼.", navi: "ì˜¤ì„¤ë¡í‹°ë®¤ì§€ì—„" }, { name: "ë³¸íƒœë°•ë¬¼ê´€", desc: "ì•ˆë„ íƒ€ë‹¤ì˜¤ ê±´ì¶•. ë¹„ ì˜¤ëŠ” ë‚  ìš´ì¹˜ ìµœê³ . (ì…ì¥ë£Œ ë¹„ìŒˆ)", navi: "ë³¸íƒœë°•ë¬¼ê´€" }] },
            { id: 'd1-11', day: 1, time: "17:50", title: "ë”ë³¸í˜¸í…” ì²´í¬ì¸", desc: "ì²´í¬ì¸ í›„ 10ì‹œ ì—°ëˆ ì˜ˆì•½ ì„±ê³µ ì—¬ë¶€ í™•ì¸.", lat: 33.2595, lng: 126.4061, type: "hotel", navi: "í˜¸í…”ë”ë³¸ì œì£¼", dist: "8km", dur: "15ë¶„", detail: "ì›°ì»´ì¿ í°ë¶(ë¹½ë‹¤ë°© ë¹µ) ê¼­ ì±™ê¸°ê¸°" },
            { id: 'd1-12', day: 1, time: "19:00", title: "ì—°ëˆ (ì €ë…)", desc: "ì˜¤ì „ 10ì‹œ í˜„ì¥ ì˜ˆì•½ ì„±ê³µ ì‹œ ì‹ì‚¬.", lat: 33.2595, lng: 126.4061, type: "meal", navi: "ì—°ëˆ", dist: "ë„ë³´", dur: "1ë¶„", detail: "ì‹¤íŒ¨ì‹œ: ë°”ë¡œ ì˜† ì—°ëˆë³¼ì¹´ì¸  í¬ì¥ ì¹˜ë§¥", alternatives: [{ name: "Plan B: ìˆ™ì„±ë„ ì¤‘ë¬¸ì ", desc: "ì œì£¼ í”„ë¦¬ë¯¸ì—„ í‘ë¼ì§€. 1ìˆœìœ„ ëŒ€ì•ˆ. (ìºì¹˜í…Œì´ë¸” í•„ìˆ˜)", navi: "ìˆ™ì„±ë„ì¤‘ë¬¸ì " }, { name: "Plan C: í°ê°¯ë¬¼íšŸì§‘", desc: "ëŒ€í¬í¬êµ¬ ë·° ìì—°ì‚° í™œì–´íšŒ. ê°€ì¡±ë¼ë¦¬ ì¡°ìš©íˆ ì‹ì‚¬.", navi: "í°ê°¯ë¬¼íšŸì§‘" }] },
            { id: 'd1-13', day: 1, time: "21:00", title: "í˜¸í…” ë£¸ ì‹œë„¤ë§ˆ", desc: "ê°€ì¡±ì„ ìœ„í•œ ì•¡ì…˜/íŒíƒ€ì§€/SF ë¬´ë¹„ ë‚˜ì‡.", lat: 33.2595, lng: 126.4061, type: "movie", dist: "í˜¸í…”ë‚´", dur: "-", detail: "ì¶”ì²œ: 'ì•„ë°”íƒ€: ë¬¼ì˜ ê¸¸', 'ê°€ë””ì–¸ì¦ˆ ì˜¤ë¸Œ ê°¤ëŸ­ì‹œ 3', 'í•´ë¦¬í¬í„° ì‹œë¦¬ì¦ˆ'. ë¹½ë‹¤ë°© ë¹µ & ë³¼ì¹´ì¸ ì™€ í•¨ê»˜.", isSpecial: true },
            // Day 2
            { id: 'd2-1', day: 2, time: "07:00", title: "íƒëª¨ë¼ (ì¡°ì‹)", desc: "í˜¸í…” ì§€í•˜ 1ì¸µ. 06:50 ì˜¤í”ˆëŸ° ì¶”ì²œ.", lat: 33.2595, lng: 126.4061, type: "meal", dist: "-", dur: "-" , detail: "ìŒ€êµ­ìˆ˜ & ìˆ˜ì œí–„ ê³µëµ" },
            { id: 'd2-2', day: 2, time: "09:00", title: "íœ´ì• ë¦¬", desc: "ë™ë°± & í‘ë¼ì§€ ì‡¼(10ì‹œ). ê°ê·¤ ë”°ê¸°.", lat: 33.2830, lng: 126.6330, type: "tour", navi: "íœ´ì• ë¦¬ìì—°ìƒí™œê³µì›", dist: "25km", dur: "40ë¶„", detail: "í‘ë¼ì§€ ì‡¼ ì‹œê°„ ë§ì¶° ì´ë™" },
            { id: 'd2-3', day: 2, time: "10:50", title: "ê·¤ê½ƒë‹¤ë½ (ì¹´í˜)", desc: "ëŒì°½ê³  ê°ì„± ì¹´í˜. ê·¤ë°­ í¬í† ì¡´.", lat: 33.2685, lng: 126.6300, type: "cafe", navi: "ê·¤ê½ƒë‹¤ë½", dist: "5km", dur: "10ë¶„", detail: "ë³¸ê´€ ê±°ìš¸ìƒ· & ë³„ê´€ì´ ì¡°ìš©í•¨", alternatives: [{ name: "ë² ì¼€ (Veke)", desc: "ì´ë¼ ì •ì›ì´ ì•„ë¦„ë‹¤ìš´ í•«í”Œ. ì¡°ìš©í•˜ê³  ì„¸ë ¨ë¨.", navi: "ë² ì¼€" }] },
            { id: 'd2-4', day: 2, time: "12:00", title: "ìš©ëˆˆì´ì˜¤ë¦„", desc: "ì™„ë§Œí•œ ê²½ì‚¬. ì •ìƒ ë·° íƒì›”.", lat: 33.4340, lng: 126.8430, type: "tour", navi: "ìš©ëˆˆì´ì˜¤ë¦„ì£¼ì°¨ì¥", dist: "23km", dur: "35ë¶„" , detail: "ì •ìƒ ë°”ëŒ ì£¼ì˜", alternatives: [{ name: "ìŠ¤ëˆ„í”¼ê°€ë“ ", desc: "ê±·ê¸° í˜ë“¤ê±°ë‚˜ ì•„ì´ë“¤ì´ ì¢‹ì•„í•  ê³³. ì‹¤ë‚´/ì‹¤ì™¸ ëª¨ë‘ ì™„ë²½.", navi: "ìŠ¤ëˆ„í”¼ê°€ë“ " }] },
            { id: 'd2-5', day: 2, time: "13:00", title: "ë‚­ëœ°ì—ì‰¼íŒ¡ (ì ì‹¬)", desc: "ì† í¸í•œ ìŒˆë°¥ ì •ì‹.", lat: 33.4500, lng: 126.6750, type: "meal", navi: "ë‚­ëœ°ì—ì‰¼íŒ¡", dist: "12km", dur: "20ë¶„", detail: "ê³ ë“±ì–´êµ¬ì´ ì¶”ê°€ ì¶”ì²œ", alternatives: [{ name: "ì„ í˜ë°©ì£¼í• ë¨¸ë‹ˆì‹ë‹¹", desc: "ê²€ì€ì½©êµ­ìˆ˜ì™€ ê³°íƒ•. ì° ë¡œì»¬ ê±´ê°• ë§›ì§‘.", navi: "ì„ í˜ë°©ì£¼í• ë¨¸ë‹ˆì‹ë‹¹" }] },
            { id: 'd2-6', day: 2, time: "14:10", title: "ì—ì½”ëœë“œ", desc: "ê¸°ì°¨ íƒ€ê³  ê³¶ìì™ˆ ìˆ² íë§.", lat: 33.4550, lng: 126.6700, type: "tour", navi: "ì—ì½”ëœë“œí…Œë§ˆíŒŒí¬", dist: "3km", dur: "5ë¶„", detail: "ë ˆì´í¬ì‚¬ì´ë“œì—­ í’ì°¨ ë°°ê²½ ì´¬ì˜", alternatives: [{ name: "ë¹„ìë¦¼", desc: "ì²œë…„ì˜ ìˆ². í”¼í†¤ì¹˜ë“œ ê°€ë“í•œ í‰ì§€ ì‚°ì±…ë¡œ.", navi: "ë¹„ìë¦¼" }, { name: "ëŒë¬¸í™”ê³µì›", desc: "ì œì£¼ì˜ ì‹ ë¹„ë¡œìš´ ë¶„ìœ„ê¸°. í•˜ëŠ˜ì—°ëª» í¬í† ì¡´.", navi: "ì œì£¼ëŒë¬¸í™”ê³µì›" }] },
            { id: 'd2-7', day: 2, time: "15:50", title: "ì¹´í˜ ë¸ë¬¸ë„", desc: "í•¨ë• ë°”ë‹¤ ìœ„ ì¹´í˜.", lat: 33.5431, lng: 126.6690, type: "cafe", navi: "ì¹´í˜ë¸ë¬¸ë„", dist: "10km", dur: "15ë¶„", detail: "ì•¼ì™¸ í…Œë¼ìŠ¤ ìë¦¬ ì„ ì  í•„ìˆ˜" },
            { id: 'd2-8', day: 2, time: "16:40", title: "ì˜ì¹´ ë°˜ë‚©", desc: "â˜…17:00 ë°˜ë‚© í•„ìˆ˜. ì£¼ìœ  í™•ì¸.", lat: 33.5080, lng: 126.4930, type: "car", navi: "ì˜ì¹´ìŠ¤í…Œì´ì…˜ì œì£¼", dist: "22km", dur: "40ë¶„", detail: "ê¸ˆìš”ì¼ í‡´ê·¼ê¸¸ ì •ì²´ ê³ ë ¤" },
            { id: 'd2-9', day: 2, time: "17:30", title: "ê³µí•­ ì €ë…/ì‡¼í•‘", desc: "ë©´ì„¸ì  ì˜¤ë©”ê¸°ë–¡/ë§ˆìŒìƒŒë“œ í”½ì—….", lat: 33.5104, lng: 126.4913, type: "meal", dist: "ì…”í‹€", dur: "15ë¶„", detail: "ì˜¤ë©”ê¸°ë–¡/ë§ˆìŒìƒŒë“œ í”½ì—…"},
            { id: 'd2-10', day: 2, time: "19:05", title: "ì²­ì£¼í–‰ ì¶œë°œ", desc: "TW836 (ìˆ˜ì† 18:25 ë§ˆê°).", flightNum: "TW836", lat: 33.5104, lng: 126.4913, type: "flight", dist: "-", dur: "-" , detail: "íƒ‘ìŠ¹êµ¬ ë²ˆí˜¸ ì¬í™•ì¸" },
            { id: 'd2-11', day: 2, time: "20:15", title: "ì²­ì£¼ê³µí•­ ë„ì°©", desc: "ì£¼ì°¨ ì •ì‚° í›„ ê·€ê°€.", lat: 36.7166, lng: 127.4991, type: "move", dist: "-", dur: "1ì‹œê°„ 10ë¶„", detail: "ì•ˆì „ ìš´ì „ ê·€ê°€" },
            { id: 'd2-12', day: 2, time: "21:20", title: "ëŒ€ì „ ì§‘ ë„ì°©", desc: "ì•ˆì „ ê·€ê°€ ì™„ë£Œ.", lat: 36.3504, lng: 127.4370, type: "move", navi: "ëŒ€ì „ë³µí•©í„°ë¯¸ë„", dist: "45km", dur: "60ë¶„", detail: "ì§ ì •ë¦¬" }
        ];

        const DRIVE_COURSE_COORDS = [
            [33.3450, 126.1700], [33.3400, 126.1650], [33.3350, 126.1620], [33.3300, 126.1600], [33.3250, 126.1580]
        ];

        const PLACES = [
            { id: 'p1', name: "ì—°ëˆ", type: "meal", main: "ë“±ì‹¬(1.1ë§Œ)/ì¹˜ì¦ˆ(1.5ë§Œ)", desc: "êµ­ë‚´ ìµœê³  ëˆê¹ŒìŠ¤ ì„±ì§€. â˜…ë‹¹ì¼ ì˜¤ì „ 10ì‹œ í˜„ì¥ í‚¤ì˜¤ìŠ¤í¬ ë“±ë¡â˜… í•„ìˆ˜.", tips: ["íˆ¬ìˆ™ê° ê¿€íŒ: ì•„ì¹¨ 9:30ì¯¤ ìŠ¬ë¦¬í¼ ì‹ ê³  ë‚˜ê°€ì„œ ì¤„ ì„œ ìˆë‹¤ê°€ ë“±ë¡í•˜ê³  ì˜¤ì„¸ìš”.", "ì¹´ë ˆ(5ì²œì›)ëŠ” ì„ íƒì´ ì•„ë‹Œ í•„ìˆ˜. ë°¥ ë¹„ë²¼ ë¨¹ìœ¼ë©´ ê·¹ë½.", "ì‹¤íŒ¨ì‹œ: ë°”ë¡œ ì˜† 'ì—°ëˆë³¼ì¹´ì¸ ' í¬ì¥í•´ì„œ í˜¸í…”ë°© ë§¥ì£¼ íŒŒí‹°."] },
            { id: 'p2', name: "ìë§¤êµ­ìˆ˜", type: "meal", main: "ê³ ê¸°êµ­ìˆ˜(10,000ì›)", desc: "ê³µí•­ ê·¼ì²˜ 1í‹°ì–´. ì§„í•œ ì‚¬ê³¨ ìœ¡ìˆ˜ì™€ ì¹˜ìë©´.", tips: ["'ìºì¹˜í…Œì´ë¸”' ì•±ìœ¼ë¡œ ê³µí•­ ë„ì°©í•˜ìë§ˆì ëŒ€ê¸° ë“±ë¡í•˜ì„¸ìš”.", "ë¹„ë¹”êµ­ìˆ˜+ë”ë² ê³ ê¸°(ì†Œ) ì¡°í•©ì´ ì§„ë¦¬."] },
            { id: 'p2-1', name: "ì´í˜¸í…Œìš° í•´ë³€", type: "tour", main: "ë¬´ë£Œ", desc: "ì œì£¼ ê³µí•­ì—ì„œ ê°€ì¥ ê°€ê¹Œìš´ í•´ìˆ˜ìš•ì¥. ë¹¨ê°„ìƒ‰, í•˜ì–€ìƒ‰ ë§ ë“±ëŒ€ê°€ ëœë“œë§ˆí¬.", tips: ["ë“±ëŒ€ ì•ì—ì„œ ì›ê·¼ë²• ìƒ· í•„ìˆ˜.", "ì£¼ì°¨ì¥ ë„“ìŒ. ê³µí•­ ê°€ëŠ” ê¸¸ì— ì ê¹ ë“¤ë¦¬ê¸° ì¢‹ìŒ."] },
            { id: 'p3', name: "í´ë­ë¸”ë£¨", type: "cafe", main: "ìš°ë„ë•…ì½©ë¼ë–¼(8.0)", desc: "í’ì°¨í•´ì•ˆë„ë¡œ ë·° ê°¤ëŸ¬ë¦¬. 2ì¸µ í†µì°½ì´ ì‹œê·¸ë‹ˆì²˜.", tips: ["2ì¸µ ì¤‘ì•™ í†µì°½ì€ í¬í† ì¡´(ì¢Œì„X)", "ì¼ëª° ì‹œê°„ëŒ€ ì—­ê´‘ ì‹¤ë£¨ì—£ ì‚¬ì§„ ëª…ì†Œ."] },
            { id: 'p4', name: "ì•Œëˆê°€", type: "meal", main: "ì•Œëˆê°€ì„¸íŠ¸(2~3ì¸ 6.5ë§Œ)", desc: "ê°€ì„±ë¹„ ìµœê³ ì˜ í‘ë¼ì§€ ìíˆ¬ë¦¬ êµ¬ì´ ì „ë¬¸ì . ì„¸íŠ¸ ë©”ë‰´ ì£¼ë¬¸ ì‹œ ëŒì†¥ë°¥ê³¼ ì°Œê°œ í¬í•¨.", tips: ["â˜…ê°•ë ¥ì¶”ì²œâ˜… 'ì•Œëˆê°€ ì„¸íŠ¸' ì‹œí‚¤ë©´ ê³ ê¸°+ëŒì†¥ë°¥+ì°Œê°œê°€ ë‹¤ ë‚˜ì˜µë‹ˆë‹¤.", "ëŒì†¥ë°¥ ë‚˜ì˜¤ëŠ” ë° 15ë¶„ ê±¸ë¦¬ë‹ˆ ì•‰ìë§ˆì ì£¼ë¬¸í•˜ì„¸ìš”.", "ê°•ëœì¥ì— ë°¥ ë¹„ë²¼ì„œ ê³ ê¸°ë‘ ë“œì‹œë©´ ê·¹ë½."] },
            { id: 'p5', name: "ë”ë³¸í˜¸í…” íƒëª¨ë¼", type: "meal", main: "í˜¸í…” ë·”í˜(1.2ë§Œ/íˆ¬ìˆ™ê°)", desc: "ë°±ì¢…ì› í˜¸í…”ë‹¤ìš´ ê°€ì„±ë¹„ ëíŒì™• ì¡°ì‹.", tips: ["07:00 ì˜¤í”ˆëŸ° í•„ìˆ˜. 07:30 ë„˜ì–´ê°€ë©´ ëŒ€ê¸° ì¤„ ê¹ë‹ˆë‹¤.", "ìŒ€êµ­ìˆ˜ ì½”ë„ˆì™€ ìˆ˜ì œ í–„ ì½”ë„ˆëŠ” ê¼­ ê³µëµí•˜ì„¸ìš”."] },
            { id: 'p6', name: "ë‚­ëœ°ì—ì‰¼íŒ¡", type: "meal", main: "ë‚­ëœ°ì •ì‹(14,000ì›)", desc: "í˜„ì§€ì¸ì´ ì°¾ëŠ” ê±´ê°• ìŒˆë°¥ì§‘. ìê·¹ì ì´ì§€ ì•Šì€ ë§›.", tips: ["ê³ ë“±ì–´êµ¬ì´(7ì²œì›) ì¶”ê°€í•˜ë©´ ì„ê¸ˆë‹˜ ìˆ˜ë¼ìƒ ì•ˆ ë¶€ëŸ¬ì›€.", "ì›¨ì´íŒ… ê¸°ê³„ ì—†ìŒ. ì¹´ìš´í„°ì—ì„œ ë²ˆí˜¸í‘œ ë°›ìœ¼ì„¸ìš”."] },
            { id: 'p7', name: "ì¹´í˜ ë¸ë¬¸ë„", type: "cafe", main: "ë² ì´ì»¤ë¦¬, ì»¤í”¼", desc: "í•œêµ­ì˜ ëª°ë””ë¸Œ í•¨ë• ë°”ë‹¤ ë°”ë¡œ ìœ„.", tips: ["ì£¼ë¬¸ ì „ ì•¼ì™¸ í…Œë¼ìŠ¤ ìë¦¬ í™•ë³´.", "ë§ˆëŠ˜ë°”ê²ŒíŠ¸ ì¶”ì²œ."] },
            { id: 'p8', name: "ì†¡ì•…ì‚° ë‘˜ë ˆê¸¸", type: "tour", main: "ë¬´ë£Œ (ì†Œìš” 1h 20m)", desc: "ì œì£¼ ì„œë‚¨ìª½ ë¹„ê²½. ì‚°ë°©ì‚°, í˜•ì œì„¬, ë§ˆë¼ë„ê°€ ë‹¤ ë³´ì„.", tips: ["ë°”ëŒì´ ì •ë§ ë§ì´ ë¶‘ë‹ˆë‹¤. ëª¨ì ë‚ ì•„ê° ì£¼ì˜.", "ì…êµ¬ ìŠ¤íƒ€ë²…ìŠ¤ì—ì„œ ìŒë£Œ ì‚¬ì„œ ì‚°ì±…í•˜ë©´ ê¿€ë§›."] },
            { id: 'p9', name: "ì¹´ë©œë¦¬ì•„í", type: "tour", main: "ì„±ì¸ 10,000ì›", desc: "ë™ì–‘ ìµœëŒ€ ë™ë°± ìˆ˜ëª©ì›. 11ì›”ì€ ë™ë°± ì‹œì¦Œ.", tips: ["í°ìƒ‰/ì•„ì´ë³´ë¦¬ìƒ‰ ì˜· ì¶”ì²œ (ì‚¬ì§„ ì˜ ë‚˜ì˜´)", "ë„¤ì´ë²„ ì˜ˆë§¤ ì‹œ í• ì¸ (ë‹¹ì¼ ì‚¬ìš© ê°€ëŠ¥ í™•ì¸ í•„ìˆ˜)."] },
            { id: 'p10', name: "íœ´ì• ë¦¬", type: "tour", main: "ì„±ì¸ 13,000ì›", desc: "ê³„ì ˆ ê½ƒ ì¶•ì œì™€ í‘ë¼ì§€ ì‡¼.", tips: ["ë§¤ì‹œ ì •ê° í‘ë¼ì§€ ì‡¼ ê´€ëŒ", "ê°ê·¤ ë”°ê¸° ì²´í—˜(ë³„ë„) ë´‰íˆ¬ ê½‰ ì±„ìš°ê¸°"] },
            { id: 'p11', name: "ì—ì½”ëœë“œ", type: "tour", main: "ì„±ì¸ 16,000ì›", desc: "ê³¶ìì™ˆ ìˆ²ì† ê¸°ì°¨ ì—¬í–‰.", tips: ["ë©”ì¸ì—­â†’ë ˆì´í¬ì‚¬ì´ë“œâ†’í”¼í¬ë‹‰ê°€ë“  ìˆœ ì´ë™", "ë§‰ì°¨ ì‹œê°„ í™•ì¸"] }
        ];

        const GUIDES = [
            { id: 'g0', icon: "shield", color: "text-red-600", title: "ğŸš¨ ì•ˆì „ & ë¹„ìƒ ì—°ë½ë§ (SOS)", content: ["ê²½ì°°ì„œ: 112, ì†Œë°©ì„œ: 119", "ì œì£¼ëŒ€ë³‘ì› ì‘ê¸‰ì‹¤ (ë¶ìª½): 064-717-1900", "ì„œê·€í¬ì˜ë£Œì› ì‘ê¸‰ì‹¤ (ë‚¨ìª½): 064-730-3000", "ë‹¬ë¹›ì–´ë¦°ì´ë³‘ì› (ì—°ë™): 064-727-3650 (ì‹¬ì•¼ ì§„ë£Œ)", "ê¸´ê¸‰ì¶œë™: ë Œí„°ì¹´ ê³„ì•½ì„œ í™•ì¸ í•„! (ì˜ì¹´ ì•± ë‚´ í˜¸ì¶œ)"] },
            { id: 'g1', icon: "alert-circle", color: "text-amber-600", title: "ğŸš¨ ì—°ëˆ ì˜ˆì•½ ë°©ì‹ ë³€ê²½ (í•„ë…)", content: ["í˜„ì¥ ì ‘ìˆ˜: ì „ë‚  ì•± ì˜ˆì•½ì€ íì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¬´ì¡°ê±´ 'ë‹¹ì¼ ì˜¤ì „ 10ì‹œ ë§¤ì¥ ì• ìºì¹˜í…Œì´ë¸” í‚¤ì˜¤ìŠ¤í¬' í˜„ì¥ ë“±ë¡ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.", "íˆ¬ìˆ™ê° ì „ëµ: í˜¸í…”ì´ ë°”ë¡œ ì˜†ì´ë‹ˆ, ì•„ì¹¨ 9ì‹œ 30ë¶„ì¯¤ ìŠ¬ë¦¬í¼ ì‹ ê³  ë‚˜ê°€ì„œ ì¤„ ì„œ ìˆë‹¤ê°€ ë“±ë¡í•˜ê³ , ë‹¤ì‹œ ë°©ì— ì™€ì„œ ì‰¬ê±°ë‚˜ ì¡°ì‹ì„ ë“œì„¸ìš”.", "ì…ì¥ ì•Œë¦¼: ì¹´í†¡ìœ¼ë¡œ 'ì§€ê¸ˆ ì…ì¥í•˜ì„¸ìš”' ì•Œë¦¼ì´ ì˜¤ë©´ 5ë¶„ ë‚´ë¡œ ê°€ì•¼ í•©ë‹ˆë‹¤."] },
            { id: 'g2', icon: "car", color: "text-green-600", title: "ğŸš— ë Œí„°ì¹´ & ìš´ì „ íŒ", content: ["ì˜ì¹´ ì…”í‹€: ê³µí•­ 1ì¸µ 5ë²ˆ ê²Œì´íŠ¸ ê±´ë„ˆí¸ 'ë Œí„°ì¹´í•˜ìš°ìŠ¤' 5êµ¬ì—­ 12ë²ˆì…ë‹ˆë‹¤. (20ë¶„ ê°„ê²©)", "ìŠˆí¼ ìì°¨: íƒ€ì´ì–´ í‘í¬, íœ  ê¸í˜ ë“± ë³´ì¥ì„ ìœ„í•´ 'ìŠˆí¼ ìì°¨(í•œë„ ë¬´ì œí•œ)' ê°•ë ¥ ì¶”ì²œ.", "íšŒì „êµì°¨ë¡œ: ì´ë¯¸ ëŒê³  ìˆëŠ” ì°¨ê°€ ìš°ì„ ì…ë‹ˆë‹¤. ì§„ì… ì‹œ ë©ˆì¶¤, ë‚˜ê°ˆ ë•Œ ìš°ì¸¡ ê¹œë¹¡ì´.", "ë°˜ë‚© ì‹œê°„: ê¸ˆìš”ì¼ ì €ë… ì œì£¼ì‹œë‚´ëŠ” í—¬ê²Œì´íŠ¸ì…ë‹ˆë‹¤. ë„¤ë¹„ë³´ë‹¤ 30ë¶„ ì—¬ìœ ë¡­ê²Œ ì¶œë°œí•˜ì„¸ìš”."] },
            { id: 'g3', icon: "plane", color: "text-blue-600", title: "âœˆï¸ ê³µí•­ ì´ìš©: ì‹œê°„ ì ˆì•½ ë¹„ë²•", content: ["ë°”ì´ì˜¤ ë“±ë¡: ì²­ì£¼ê³µí•­ 2ì¸µì—ì„œ ë“±ë¡í•˜ë©´ ì‹ ë¶„ì¦ ì—†ì´ ì „ìš© ê²Œì´íŠ¸ë¡œ 1ì´ˆ í†µê³¼.", "ëª¨ë°”ì¼ ì²´í¬ì¸: 24ì‹œê°„ ì „ ì¹´í†¡ ì•Œë¦¼ ì˜¤ë©´ ì¦‰ì‹œ ì ‘ì†í•´ì„œ ì•ì¢Œì„(1~5ì—´) ì„ ì .", "ê¸°ë‚´ ë°˜ì… ê¸ˆì§€: ë³´ì¡°ë°°í„°ë¦¬, ë¼ì´í„°, ì „ìë‹´ë°°ëŠ” ë¬´ì¡°ê±´ ê¸°ë‚´ ê°€ë°©ì—! (ìœ„íƒ ë¶ˆê°€)"] },
            { id: 'g4', icon: "camera", color: "text-pink-600", title: "ğŸ“¸ 11ì›” ì œì£¼ ë‚ ì”¨ & ì˜·ì°¨ë¦¼", content: ["ë°”ëŒê³¼ì˜ ì „ìŸ: ì²´ê°ì˜¨ë„ ë‚®ìŒ. ê²½ëŸ‰ íŒ¨ë”© ì¡°ë¼ë‚˜ ë°”ëŒë§‰ì´ í•„ìˆ˜.", "ìƒ‰ê° ë§¤ì¹˜: ë™ë°±ê½ƒ(ì¹´ë©œë¦¬ì•„í)ì—” í°ìƒ‰/ì•„ì´ë³´ë¦¬. ê·¤ë°­ì—” ë² ì´ì§€/ì¹´í‚¤.", "ì‚¼ê°ëŒ€: ê°€ë²¼ìš´ ê±´ ë°”ëŒì— ë„˜ì–´ì§‘ë‹ˆë‹¤. ê°€ë°© ê±¸ì–´ì„œ ë¬´ê²Œ ì¤‘ì‹¬ ë‚®ì¶”ì„¸ìš”."] },
            { id: 'g5', icon: "gift", color: "text-purple-600", title: "ğŸ ì‡¼í•‘ & ë¨¹ê±°ë¦¬: í˜¸ê°± íƒˆì¶œ", content: ["ì´ˆì½œë¦¿: 10ë°•ìŠ¤ ë§Œì›ì§œë¦¬ ë§ê³  'ì œì£¼ ë¦¬ì–¼ íƒ€ë¥´íŠ¸'ë‚˜ 'ê³¼ì¦' ì¶”ì²œ.", "ì˜¤ë©”ê¸°ë–¡: ë‚±ê°œ í¬ì¥ëœ 'ëƒ‰ë™'ìœ¼ë¡œ ì‚¬ì•¼ ê´€ë¦¬ í¸í•¨.", "ë§ˆìŒìƒŒë“œ: íŒŒë¦¬ë°”ê²ŒíŠ¸ ì•±ìœ¼ë¡œ 3ì¼ ì „ ì˜ˆì•½í•˜ê³  ë Œí„°ì¹´í•˜ìš°ìŠ¤ì ì—ì„œ í”½ì—….", "íšŒ í¬ì¥: ë™ë¬¸ì‹œì¥ ì•¼ì‹œì¥ë³´ë‹¤ëŠ” 'ì¤‘ë¬¸ í•˜ë‚˜ë¡œë§ˆíŠ¸' íšŒ ì½”ë„ˆê°€ ê°€ì„±ë¹„ ê°‘."] }
        ];

        const COST_DATA = [
            { id: 'c1', cat: "ì‚¬ì „ ê²°ì œ (êµí†µ/ìˆ™ë°•)", items: [{id: 'i1', n:'í•­ê³µë£Œ(ì™•ë³µ 3ì¸+ ì‚¬ì „ì¢Œì„)', v: 529200}, {id: 'i2', n:'ìˆ™ë°• (ë”ë³¸ 1ë°•)', v: 166000}, {id: 'i3', n:'ë Œí„°ì¹´ (EV3/ìì°¨)', v: 157610}] },
            { id: 'c2', cat: "í˜„ì¥ ì‹ë¹„", items: [
                {id: 'i4', n:'ìë§¤êµ­ìˆ˜ (3ì¸)', v: 30000}, 
                {id: 'i5', n:'ì•Œëˆê°€ (ì„¸íŠ¸ë©”ë‰´)', v: 70000}, 
                {id: 'i6', n:'ì—°ëˆ (ëˆê¹ŒìŠ¤+ì¹´ë ˆ)', v: 60000}, 
                {id: 'i7', n:'íƒëª¨ë¼ ì¡°ì‹ (ìˆ™ë°•í¬í•¨)', v: 0},
                {id: 'i8', n:'ë‚­ëœ°ì—ì‰¼íŒ¡', v: 50000}, 
                {id: 'i9', n:'ê³µí•­ ì €ë…', v: 40000}, 
                {id: 'i10', n:'ì¹´í˜ 4ê³³', v: 120000}
            ]},
            { id: 'c3', cat: "ì…ì¥ë£Œ/ê¸°íƒ€", items: [{id: 'i11', n:'ì¹´ë©œë¦¬ì•„í (3ì¸)', v: 30000}, {id: 'i12', n:'íœ´ì• ë¦¬ (3ì¸)', v: 39000}, {id: 'i13', n:'ì—ì½”ëœë“œ (3ì¸)', v: 48000}, {id: 'i14', n:'ì£¼ìœ /ì¡ë¹„', v: 30000}] }
        ];

        const CHECKLIST = ['ì‹ ë¶„ì¦ (ì „ì› í•„ìˆ˜)', 'ìš´ì „ë©´í—ˆì¦', 'ì¶©ì „ê¸°/ë³´ì¡°ë°°í„°ë¦¬', 'ë°”ëŒë§‰ì´/ê²½ëŸ‰íŒ¨ë”©', 'ë¹„ìƒì•½', 'ì‚¼ê°ëŒ€', 'ì„ ê¸€ë¼ìŠ¤', 'ë¬¼í‹°ìŠˆ', 'ìš°ì‚°/ìš°ë¹„', 'ì„¸ë©´ë„êµ¬(ì¹«ì†”)'];
        const MUSIC_LINKS = [ { name: "ğŸš— ì‹ ë‚˜ëŠ” ë“œë¼ì´ë¸Œ", url: "https://www.youtube.com/results?search_query=driving+playlist+kpop" }, { name: "ğŸŒŠ ì œì£¼ ë°”ë‹¤ ê°ì„±", url: "https://www.youtube.com/results?search_query=jeju+vibe+playlist" }, { name: "â˜” ë¹„ ì˜¤ëŠ” ë‚ ", url: "https://www.youtube.com/results?search_query=rainy+day+jazz" } ];

        // =========================================
        // [í•„ìˆ˜] í—¬í¼ í•¨ìˆ˜ ì •ì˜
        // =========================================
        const formatCost = (num) => num.toLocaleString();
        const calculateDistance = (lat1, lng1, lat2, lng2) => {
            if(!lat1 || !lng1 || !lat2 || !lng2) return 0;
            const R = 6371; const dLat = (lat2 - lat1) * (Math.PI / 180); const dLon = (lng2 - lng1) * (Math.PI / 180);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return (R * c).toFixed(1);
        };
        const useLeaflet = () => { const [loaded, setLoaded] = useState(false); useEffect(() => { if (window.L && window.L.map) { setLoaded(true); return; } setLoaded(true); }, []); return loaded; };
        
        // ê²€ìƒ‰ì–´ ì •ë¦¬ ê¸°ëŠ¥ ì¶”ê°€ (ê´„í˜¸ ë‚´ìš© ì œê±°)
        const openNavi = (name) => { 
            const cleanName = name.replace(/\([^)]*\)/g, '').trim(); 
            const isMobile = /Android|iPhone/i.test(navigator.userAgent); 
            const url = isMobile ? `https://m.map.naver.com/search2/search.naver?query=${encodeURIComponent(cleanName)}` : `https://map.naver.com/v5/search/${encodeURIComponent(cleanName)}`; 
            window.open(url, '_blank'); 
        };
        
        const openFlightSearch = (flightNum) => { window.open(`https://search.naver.com/search.naver?query=${encodeURIComponent(flightNum + " ìš´í•­ì •ë³´")}`, '_blank'); };
        const openNearbySearch = (title, category) => { const cleanName = title.replace(/\([^)]*\)/g, '').replace(/ë‘˜ë ˆê¸¸|í•´ì•ˆë„ë¡œ|ë§›ì§‘|ì¹´í˜/g, '').replace(/&/g, ' ').trim(); const query = `${cleanName} ${category}`; const isMobile = /Android|iPhone/i.test(navigator.userAgent); const url = isMobile ? `https://m.map.naver.com/search2/search.naver?query=${encodeURIComponent(query)}` : `https://map.naver.com/v5/search/${encodeURIComponent(query)}`; window.open(url, '_blank'); };
        const getItemDate = (day, time) => { const dateMap = {0: 26, 1: 27, 2: 28}; if(!dateMap[day] || !time || !time.includes(':')) return null; const [h, m] = time.split(':').map(Number); return new Date(2025, 10, dateMap[day], h, m); };

        // OSRM ê²½ë¡œ (ë¹„ë™ê¸°)
        const fetchRoute = async (start, end) => {
            try { const response = await fetch(`https://router.project-osrm.org/route/v1/driving/${start[1]},${start[0]};${end[1]},${end[0]}?overview=full&geometries=geojson`); const data = await response.json(); if (data.code === 'Ok' && data.routes && data.routes.length > 0) { return data.routes[0].geometry.coordinates.map(coord => [coord[1], coord[0]]); } } catch (e) { console.warn("Routing failed", e); } return [start, end];
        };

        // =========================================
        // 4. ë©”ì¸ App ì»´í¬ë„ŒíŠ¸
        // =========================================
        function App() {
            const [scheduleData, setScheduleData] = useState(() => { const saved = localStorage.getItem('jeju_schedule_v6'); return saved ? JSON.parse(saved) : SCHEDULE; });
            const [placesData, setPlacesData] = useState(() => { const saved = localStorage.getItem('jeju_places_v6'); return saved ? JSON.parse(saved) : PLACES; });
            const [costData, setCostData] = useState(() => { const saved = localStorage.getItem('jeju_cost_data_v6'); return saved ? JSON.parse(saved) : COST_DATA; });
            
            const [activeTab, setActiveTab] = useState('timeline');
            const [weather, setWeather] = useState(null);
            const [currentTime, setCurrentTime] = useState(TEST_DATE_STRING ? new Date(TEST_DATE_STRING) : new Date());
            const [isChatOpen, setIsChatOpen] = useState(false);
            const [isMapPopupOpen, setIsMapPopupOpen] = useState(false);
            const [selectedPlace, setSelectedPlace] = useState(null);
            const [toastMsg, setToastMsg] = useState(null);
            const [activeScheduleItem, setActiveScheduleItem] = useState(null); 
            const [tripProgress, setTripProgress] = useState(0);
            const [isMusicMenuOpen, setIsMusicMenuOpen] = useState(false);
            const [isWeatherVisible, setIsWeatherVisible] = useState(true);
            const [isResetMenuOpen, setIsResetMenuOpen] = useState(false); 
            
            const [visitedPlaces, setVisitedPlaces] = useState(() => { const saved = localStorage.getItem('jeju_visited'); return saved ? JSON.parse(saved) : []; });
            const [actualCosts, setActualCosts] = useState(() => { const saved = localStorage.getItem('jeju_costs'); return saved ? JSON.parse(saved) : {}; });
            const [checklistState, setChecklistState] = useState(() => { const saved = localStorage.getItem('jeju_checklist'); return saved ? JSON.parse(saved) : {}; });
            const [photoLogs, setPhotoLogs] = useState(() => { const saved = localStorage.getItem('jeju_photologs'); return saved ? JSON.parse(saved) : {}; });
            const [memoState, setMemoState] = useState(() => { const saved = localStorage.getItem('jeju_memos'); return saved ? JSON.parse(saved) : {}; });
            
            // Refs
            const mapRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const routeLayerGroupRef = useRef(null);
            const popupMapRef = useRef(null);
            const popupMapInstanceRef = useRef(null);
            const popupLayerGroupRef = useRef(null);
            const routeCacheRef = useRef({});
            const fileInputRefs = useRef({});
            const restoreInputRef = useRef(null);
            const activeItemRef = useRef(null);
            const isLeafletLoaded = useLeaflet();

            useEffect(() => { localStorage.setItem('jeju_schedule_v6', JSON.stringify(scheduleData)); }, [scheduleData]);
            useEffect(() => { localStorage.setItem('jeju_places_v6', JSON.stringify(placesData)); }, [placesData]);
            useEffect(() => { localStorage.setItem('jeju_cost_data_v6', JSON.stringify(costData)); }, [costData]);
            useEffect(() => { localStorage.setItem('jeju_visited', JSON.stringify(visitedPlaces)); }, [visitedPlaces]);
            useEffect(() => { localStorage.setItem('jeju_costs', JSON.stringify(actualCosts)); }, [actualCosts]);
            useEffect(() => { localStorage.setItem('jeju_checklist', JSON.stringify(checklistState)); }, [checklistState]);
            useEffect(() => { localStorage.setItem('jeju_photologs', JSON.stringify(photoLogs)); }, [photoLogs]);
            useEffect(() => { localStorage.setItem('jeju_memos', JSON.stringify(memoState)); }, [memoState]);

            useEffect(() => {
                const fetchWeather = async () => {
                    try { const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=33.25&longitude=126.56&current=temperature_2m,relative_humidity_2m,wind_speed_10m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_probability_max&timezone=Asia%2FTokyo'); const data = await res.json(); if (data) setWeather(data); } catch (e) { console.error("Weather Error", e); }
                };
                fetchWeather();
                if (!TEST_DATE_STRING) { const timer = setInterval(() => setCurrentTime(new Date()), 1000); return () => clearInterval(timer); }
            }, []);

            useEffect(() => {
                const tripStart = new Date(2025, 10, 27, 4, 50);
                const tripEnd = new Date(2025, 10, 28, 21, 20);
                const totalDuration = tripEnd - tripStart;
                const elapsed = currentTime - tripStart;
                let progress = 0;
                if (elapsed > 0) progress = Math.min(100, (elapsed / totalDuration) * 100);
                setTripProgress(progress);
                let foundActive = null;
                scheduleData.forEach(item => {
                    const itemDate = getItemDate(item.day, item.time);
                    if (itemDate && currentTime >= itemDate) foundActive = item;
                });
                if (!foundActive && progress < 0) foundActive = scheduleData[0];
                setActiveScheduleItem(foundActive);

                if (foundActive && activeItemRef.current === null) {
                    setTimeout(() => {
                        const el = document.getElementById(`item-${foundActive.id}`);
                        if (el) {
                            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            setToastMsg(`í˜„ì¬ ì¼ì •: ${foundActive.title}`);
                            activeItemRef.current = foundActive.id; 
                        }
                    }, 800);
                }
            }, [currentTime, scheduleData]);

            const getDDay = () => { const tripDate = new Date('2025-11-27T00:00:00'); const now = TEST_DATE_STRING ? new Date(TEST_DATE_STRING) : new Date(); const diff = Math.ceil((tripDate - now) / (1000 * 60 * 60 * 24)); if (diff > 0) return `D-${diff}`; if (diff === 0) return "Day 1"; if (diff === -1) return "Day 2"; return "ì—¬í–‰ì¢…ë£Œ"; };
            const getWeatherIcon = (code) => { if (code > 50) return <Icon name="cloud-rain" size={14} className="text-blue-400"/>; if (code > 3) return <Icon name="cloud" size={14} className="text-slate-400"/>; return <Icon name="sun" size={14} className="text-amber-400"/>; };
            const getTypeIcon = (type) => { switch (type) { case 'meal': return <Icon name="utensils" size={16} />; case 'cafe': return <Icon name="coffee" size={16} />; case 'tour': return <Icon name="camera" size={16} />; case 'flight': return <Icon name="plane" size={16} />; case 'car': return <Icon name="car" size={16} />; case 'hotel': return <Icon name="home" size={16} />; case 'movie': return <Icon name="film" size={16} />; default: return <Icon name="map-pin" size={16} />; } };
            const toggleStamp = (e, id) => { e.stopPropagation(); if (visitedPlaces.includes(id)) { setVisitedPlaces(visitedPlaces.filter(pid => pid !== id)); } else { setVisitedPlaces([...visitedPlaces, id]); setToastMsg("ğŸ‰ ë°©ë¬¸ ì¸ì¦ ì™„ë£Œ! ìŠ¤íƒ¬í”„ ì¾…!"); } };
            const handleCostChange = (id, value) => { const numVal = parseInt(value.replace(/[^0-9]/g, ''), 10) || 0; setActualCosts(prev => ({ ...prev, [id]: numVal })); };
            const toggleChecklist = (item) => { setChecklistState(prev => ({ ...prev, [item]: !prev[item] })); };
            const handlePhotoUpload = (e, id) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onloadend = () => { setPhotoLogs(prev => ({ ...prev, [id]: reader.result })); setToastMsg("ğŸ“¸ ì‚¬ì§„ì´ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! (ë¡œì»¬ ì €ì¥)"); }; reader.readAsDataURL(file); } };
            const handlePhotoDelete = (e, id) => { e.stopPropagation(); if (window.confirm("ì •ë§ ì´ ì‚¬ì§„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { const newLogs = { ...photoLogs }; delete newLogs[id]; setPhotoLogs(newLogs); setToastMsg("ğŸ—‘ï¸ ì‚¬ì§„ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."); } };
            const handleMemoChange = (id, value) => { setMemoState(prev => ({ ...prev, [id]: value })); };
            const handlePrint = () => { window.print(); };

            // ê³µìœ  ê¸°ëŠ¥ ì¶”ê°€
            const shareLocation = (item) => {
                const cleanTitle = item.title.replace(/\([^)]*\)/g, '').trim();
                const shareData = {
                    title: cleanTitle,
                    text: `ì œì£¼ ì—¬í–‰ ì¤‘: ${cleanTitle}\n${item.desc}`,
                    url: `https://m.map.naver.com/search2/search.naver?query=${encodeURIComponent(cleanTitle)}`
                };

                if (navigator.share) {
                    navigator.share(shareData).catch(err => console.log('ê³µìœ  ì‹¤íŒ¨', err));
                } else {
                    navigator.clipboard.writeText(`${cleanTitle}\n${item.desc}\n${shareData.url}`);
                    setToastMsg("ğŸ“‹ ì£¼ì†Œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! ì¹´í†¡ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.");
                }
            };

            const exportToCalendar = () => {
                const dateMap = {0: '20251126', 1: '20251127', 2: '20251128'};
                let icsContent = `BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//JejuMasterpiece//KR\nCALSCALE:GREGORIAN\nMETHOD:PUBLISH\n`;
                scheduleData.forEach((item) => {
                    const date = dateMap[item.day];
                    let timeStart = '000000';
                    let timeEnd = '010000';
                    if (item.time && item.time.includes(':')) {
                        const [h, m] = item.time.split(':');
                        timeStart = `${h}${m}00`;
                        let endH = parseInt(h) + 1;
                        timeEnd = `${endH < 10 ? '0'+endH : endH}${m}00`;
                    }
                    icsContent += `BEGIN:VEVENT\nSUMMARY:${item.title}\nDTSTART:${date}T${timeStart}\nDTEND:${date}T${timeEnd}\nDESCRIPTION:${item.desc}\nLOCATION:${item.navi || 'ì œì£¼ë„'}\nEND:VEVENT\n`;
                });
                icsContent += `END:VCALENDAR`;
                const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
                const link = document.createElement('a');
                link.href = window.URL.createObjectURL(blob);
                link.setAttribute('download', 'jeju_plan.ics');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // ----------------------------------------------------------------------------------
            // [CORE FUNCTION] ì¼ì • ì—…ë°ì´íŠ¸ í•¸ë“¤ëŸ¬ (ë²„ê·¸ ìˆ˜ì • ë° ê¸°ëŠ¥ ê°•í™”)
            // ----------------------------------------------------------------------------------
            const handleUpdateSchedule = (updateDataInput) => {
                const updates = Array.isArray(updateDataInput) ? updateDataInput : [updateDataInput];

                let currentSchedule = [...scheduleData];
                let currentCostData = [...costData];
                let currentPlaces = [...placesData];
                let currentActualCosts = {...actualCosts};

                updates.forEach(updateData => {
                    // 1. [ë²„ê·¸ ìˆ˜ì •ë¨] ì´ì „ ì¥ì†Œ ì‚­ì œ ë¡œì§ (ìŠ¤ë§ˆíŠ¸ ë§¤ì¹­)
                    // ê¸°ì¡´: ë‹¨ìˆœíˆ titleê³¼ nameì´ ì •í™•íˆ ì¼ì¹˜í•´ì•¼ ì‚­ì œë¨ -> ìˆ˜ì •: í¬í•¨ ì—¬ë¶€ ë° íŠ¹ìˆ˜ë¬¸ì ì œê±° í›„ ë¹„êµ
                    const targetItem = currentSchedule.find(s => s.id === updateData.targetId);
                    if (targetItem) {
                        // ì¼ì •ì´ "í´ë­ë¸”ë£¨ & í’ì°¨í•´ì•ˆë„ë¡œ"ì¼ ê²½ìš° "í´ë­ë¸”ë£¨", "í’ì°¨í•´ì•ˆë„ë¡œ" ë‘˜ ë‹¤ ì²´í¬
                        const potentialNames = targetItem.title.split(/[&+\/]/).map(s => s.replace(/\([^)]*\)/g, '').trim());
                        
                        // í”Œë ˆì´ìŠ¤ ëª©ë¡ì—ì„œ ìœ„ í‚¤ì›Œë“œë¥¼ í¬í•¨í•˜ëŠ” í•­ëª© ì œê±°
                        currentPlaces = currentPlaces.filter(p => {
                            const placeName = p.name.replace(/\s/g, ''); // ê³µë°±ì œê±°
                            const isMatch = potentialNames.some(keyword => {
                                const cleanKeyword = keyword.replace(/\s/g, '');
                                return placeName === cleanKeyword || placeName.includes(cleanKeyword) || cleanKeyword.includes(placeName);
                            });
                            return !isMatch; // ë§¤ì¹­ë˜ë©´ ì œê±° (false ë°˜í™˜)
                        });
                    }

                    // 2. ì¼ì • ì—…ë°ì´íŠ¸
                    currentSchedule = currentSchedule.map(item => {
                        if (item.id === updateData.targetId) {
                            return {
                                ...item,
                                title: updateData.newTitle,
                                desc: updateData.newDesc,
                                lat: updateData.newLat,
                                lng: updateData.newLng,
                                navi: updateData.newTitle,
                                detail: updateData.newDetail ? `${updateData.newDetail}` : item.detail,
                            };
                        }
                        return item;
                    });

                    // 3. ë¹„ìš©(Cost) ì—…ë°ì´íŠ¸
                    if (updateData.costUpdate) {
                        const { targetItemName, newItemName, newAmount } = updateData.costUpdate;
                        let updatedCostId = null;

                        currentCostData = currentCostData.map(g => ({
                            ...g,
                            items: g.items.map(i => {
                                const cleanCurrent = i.n.replace(/\s/g, '');
                                const cleanTarget = targetItemName.replace(/\s/g, '');
                                if (i.n.includes(targetItemName) || cleanCurrent.includes(cleanTarget)) {
                                    updatedCostId = i.id;
                                    return { ...i, n: newItemName, v: newAmount };
                                }
                                return i;
                            })
                        }));

                        if (updatedCostId && currentActualCosts[updatedCostId]) {
                            delete currentActualCosts[updatedCostId];
                        }
                    }

                    // 4. ìƒˆë¡œìš´ í”Œë ˆì´ìŠ¤ ì •ë³´ ì¶”ê°€
                    if (updateData.newPlaceInfo) {
                        const newP = updateData.newPlaceInfo;
                        const exists = currentPlaces.find(p => p.name === newP.name);
                        if (!exists) {
                            currentPlaces = [newP, ...currentPlaces];
                        }
                    }
                });

                // ê±°ë¦¬ ì¬ê³„ì‚° ë¡œì§
                for (let i = 0; i < currentSchedule.length - 1; i++) {
                    const curr = currentSchedule[i];
                    const next = currentSchedule[i+1];
                    if (curr.day === next.day && curr.lat && next.lat && curr.type !== 'flight' && next.type !== 'flight') {
                         const d = calculateDistance(curr.lat, curr.lng, next.lat, next.lng);
                         next.dist = `${d}km`;
                         next.dur = `${Math.ceil(d*1.5+5)}ë¶„`;
                    }
                }

                setScheduleData(currentSchedule);
                setCostData(currentCostData);
                setPlacesData(currentPlaces);
                setActualCosts(currentActualCosts);
                
                const msg = updates.length > 1 
                    ? `âœ¨ ${updates[0].newTitle} ì™¸ ${updates.length - 1}ê±´ì˜ ì¼ì •ì´ ìµœì í™”ë˜ì—ˆìŠµë‹ˆë‹¤!`
                    : `âœ¨ ${updates[0].newTitle}(ìœ¼)ë¡œ ë³€ê²½ ì™„ë£Œ! (í”Œë ˆì´ìŠ¤/ê²½ë¹„ ìˆ˜ì •ë¨)`;
                setToastMsg(msg);
            };

            const handleSelectReset = (option) => {
                if (!window.confirm("ì„ íƒí•œ í•­ëª©ì„ ì •ë§ ì´ˆê¸° ìƒíƒœë¡œ ë˜ëŒë¦´ê¹Œìš”?")) return;

                if (option === 'all') {
                    setScheduleData(SCHEDULE); setPlacesData(PLACES); setCostData(COST_DATA);
                    localStorage.clear(); 
                    setToastMsg("ğŸ”„ ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    setTimeout(() => window.location.reload(), 500);
                } else if (option === 'day1') {
                    setScheduleData(prev => [...SCHEDULE.filter(s => s.day === 1), ...prev.filter(s => s.day !== 1)]);
                    setToastMsg("ğŸ”„ 1ì¼ì°¨ ì¼ì •ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
                } else if (option === 'day2') {
                    setScheduleData(prev => [...SCHEDULE.filter(s => s.day === 2), ...prev.filter(s => s.day !== 2)]);
                    setToastMsg("ğŸ”„ 2ì¼ì°¨ ì¼ì •ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
		        } else if (option === 'place') {
                    setPlacesData(PLACES);
                    setToastMsg("ğŸ”„ í”Œë ˆì´ìŠ¤ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
                } else if (option === 'cost') {
                    setCostData(COST_DATA);
                    setActualCosts({});
                    setToastMsg("ğŸ’° ê²½ë¹„ ë‚´ì—­ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
                }
                setIsResetMenuOpen(false);
                setIsChatOpen(false);
            };
            
            const handleResetSchedule = () => {
                setIsResetMenuOpen(true);
            };

            const backupData = () => {
                const data = { scheduleData, placesData, costData, visitedPlaces, actualCosts, checklistState, photoLogs, memoState, timestamp: new Date().toISOString() };
                const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
                const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `jeju_backup_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(link); link.click(); document.body.removeChild(link); setToastMsg("ğŸ’¾ ë°±ì—… íŒŒì¼ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            };

            const restoreData = (e) => {
                const file = e.target.files[0]; if (!file) return; const reader = new FileReader();
                reader.onload = (evt) => {
                    try { const d = JSON.parse(evt.target.result); if(d.scheduleData) setScheduleData(d.scheduleData); if(d.placesData) setPlacesData(d.placesData); if(d.costData) setCostData(d.costData); if(d.visitedPlaces) setVisitedPlaces(d.visitedPlaces); if(d.actualCosts) setActualCosts(d.actualCosts); if(d.checklistState) setChecklistState(d.checklistState); if(d.photoLogs) setPhotoLogs(d.photoLogs); if(d.memoState) setMemoState(d.memoState); setToastMsg("â™»ï¸ ë°ì´í„° ë³µì› ì™„ë£Œ!"); } catch (err) { alert("íŒŒì¼ ì˜¤ë¥˜"); }
                }; reader.readAsText(file); e.target.value = null;
            };

            const getCostSummary = () => {
                const summary = { c1: 0, c2: 0, c3: 0, totalSpent: 0, totalBudget: 0 };
                summary.totalBudget = costData.reduce((acc, grp) => acc + grp.items.reduce((s, i) => s + i.v, 0), 0);
                Object.keys(actualCosts).forEach(key => {
                    const val = actualCosts[key];
                    if (['i1', 'i2', 'i3'].includes(key)) summary.c1 += val; else if (['i11', 'i12', 'i13', 'i14'].includes(key)) summary.c3 += val; else summary.c2 += val;
                    summary.totalSpent += val;
                });
                return summary;
            };
            const costSummary = getCostSummary();
            const spentPercent = Math.min(100, Math.round((costSummary.totalSpent / costSummary.totalBudget) * 100)) || 0;
            const c1Deg = costSummary.totalSpent ? (costSummary.c1 / costSummary.totalSpent) * 360 : 0;
            const c2Deg = costSummary.totalSpent ? (costSummary.c2 / costSummary.totalSpent) * 360 : 0;

            // [ì‹ ê·œ ê¸°ëŠ¥] ì—¬í–‰ ìŠ¤íƒ€ì¼ ë¶„ì„ (Gamification)
            const getTravelStyle = () => {
                const activities = scheduleData.filter(s => s.type === 'tour' || s.type === 'cafe' || s.type === 'meal');
                const total = activities.length;
                if (total === 0) return { title: "ì—¬í–‰ ì¤€ë¹„ ì¤‘..", desc: "ì•„ì§ ì¼ì •ì´ ì—†ì–´ìš”!", icon: "loader", color: "text-slate-400" };

                const meals = activities.filter(s => s.type === 'meal' || s.type === 'cafe').length;
                const tours = activities.filter(s => s.type === 'tour').length;
                
                const foodRatio = meals / total;
                const tourRatio = tours / total;

                if (foodRatio > 0.6) return { title: "ğŸŠ ë§›ì§‘ íƒë°©ê°€ (Foodie)", desc: "ì œì£¼ì˜ ë§›ì„ ì •ë³µí•˜ëŸ¬ ì˜¤ì…¨êµ°ìš”! ì‹ë„ë½ ì—¬í–‰ ìµœê³ !", icon: "utensils", color: "text-orange-600", bg: "bg-orange-100" };
                if (tourRatio > 0.6) return { title: "ğŸƒ ë¶€ì§€ëŸ°í•œ íƒí—˜ê°€ (Explorer)", desc: "1ë¶„ 1ì´ˆê°€ ì•„ê¹ë‹¤! í•«í”Œ ì •ë³µëŸ¬ ìŠ¤íƒ€ì¼.", icon: "map", color: "text-blue-600", bg: "bg-blue-100" };
                return { title: "ğŸŒ¿ ì—¬ìœ ë¡œìš´ íëŸ¬ (Healer)", desc: "ë¨¹ê³  ë³´ê³  ì‰¬ê³ , ë°¸ëŸ°ìŠ¤ê°€ ì™„ë²½í•œ ì—¬í–‰ ê³ ìˆ˜.", icon: "smile", color: "text-green-600", bg: "bg-green-100" };
            };

            const drawMapLayers = async (layerGroup) => {
                if (!layerGroup) return;
                layerGroup.clearLayers();
                const days = [1, 2];
                let markerSequence = 1; 
                const segmentsToFetch = []; 

                for (const day of days) {
                    const color = day === 1 ? '#0F766E' : '#F97316';
                    const daySegments = scheduleData.filter(s => s.day === day && s.lat && s.lng && s.type !== 'flight');
                    if (daySegments.length === 0) continue;

                    daySegments.forEach((s) => {
                        const sequenceIcon = L.divIcon({
                            className: 'custom-map-icon',
                            html: `<div class="map-marker-badge" style="background-color: ${color};">${markerSequence}</div>`,
                            iconSize: [24, 24],
                            iconAnchor: [12, 12]
                        });
                        const marker = L.marker([s.lat, s.lng], { icon: sequenceIcon }).addTo(layerGroup);
                        marker.bindPopup(`
                            <div style="text-align:center;">
                                <div style="font-size:14px; font-weight:bold; color:${color}; margin-bottom:4px;">${markerSequence}. ${s.title}</div>
                                <div style="font-size:11px; color:#666;">${s.desc}</div>
                            </div>
                        `);
                        marker.on('click', () => {
                            document.getElementById(`item-${s.id}`)?.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            setActiveTab('timeline');
                        });
                        markerSequence++;
                    });

                    const simplePts = daySegments.map(s => [s.lat, s.lng]);
                    L.polyline(simplePts, { color: color, weight: 3, opacity: 0.4, dashArray: '5, 10' }).addTo(layerGroup);

                    if (daySegments.length > 1) {
                        for (let i = 0; i < daySegments.length - 1; i++) {
                            const start = [daySegments[i].lat, daySegments[i].lng];
                            const end = [daySegments[i+1].lat, daySegments[i+1].lng];
                            const cacheKey = `${start.join(',')}-${end.join(',')}`;
                            if (routeCacheRef.current[cacheKey]) {
                                L.polyline(routeCacheRef.current[cacheKey], { color: color, weight: 5, opacity: 0.8 }).addTo(layerGroup);
                            } else {
                                segmentsToFetch.push({ start, end, cacheKey, color });
                            }
                        }
                    }
                }
                L.polyline(DRIVE_COURSE_COORDS, { color: '#06b6d4', weight: 6, opacity: 0.6 }).addTo(layerGroup);

                const processRouteQueue = async () => {
                    for (const segment of segmentsToFetch) {
                        try {
                            await new Promise(resolve => setTimeout(resolve, 1200));
                            if (!layerGroup._map) break;
                            const coords = await fetchRoute(segment.start, segment.end);
                            routeCacheRef.current[segment.cacheKey] = coords; 
                            if (coords && layerGroup._map) {
                                L.polyline(coords, { color: segment.color, weight: 5, opacity: 0.8 }).addTo(layerGroup);
                            }
                        } catch (e) { console.warn("Queue processing warning", e); }
                    }
                };
                if (segmentsToFetch.length > 0) { processRouteQueue(); }
            };

            useEffect(() => {
                if (isLeafletLoaded && mapRef.current && !mapInstanceRef.current && window.L) { 
                    const map = L.map(mapRef.current, { zoomControl: false, attributionControl: false }).setView([33.38, 126.55], 10); 
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map); 
                    mapInstanceRef.current = map;
                    routeLayerGroupRef.current = L.layerGroup().addTo(map);
                }
                if (mapInstanceRef.current && routeLayerGroupRef.current) {
                    drawMapLayers(routeLayerGroupRef.current);
                }
            }, [isLeafletLoaded, scheduleData]);

            useEffect(() => {
                if (isMapPopupOpen && isLeafletLoaded && popupMapRef.current && window.L) {
                    if (!popupMapInstanceRef.current) { 
                        popupMapInstanceRef.current = L.map(popupMapRef.current).setView([33.38, 126.55], 10); 
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(popupMapInstanceRef.current); 
                        popupLayerGroupRef.current = L.layerGroup().addTo(popupMapInstanceRef.current);
                    }
                    const map = popupMapInstanceRef.current; 
                    setTimeout(() => map.invalidateSize(), 200);
                    if (popupLayerGroupRef.current) { drawMapLayers(popupLayerGroupRef.current); }
                    if (selectedPlace && selectedPlace.lat) { 
                        map.setView([selectedPlace.lat, selectedPlace.lng], 14); 
                        L.circleMarker([selectedPlace.lat, selectedPlace.lng], {
                            radius: 10, fillColor: '#EF4444', color: 'white', weight: 2, fillOpacity: 0.9
                        }).addTo(popupLayerGroupRef.current).bindPopup(`<b>${selectedPlace.title}</b>`).openPopup();
                    }
                }
            }, [isMapPopupOpen, selectedPlace, scheduleData]);

            const openMapPopup = (item) => { setSelectedPlace(item); setIsMapPopupOpen(true); };
            const closeMapPopup = () => { setIsMapPopupOpen(false); setSelectedPlace(null); if (popupMapInstanceRef.current) { popupMapInstanceRef.current.remove(); popupMapInstanceRef.current = null; popupLayerGroupRef.current = null; } };
            const locateUser = () => { if (!mapInstanceRef.current) return; const map = mapInstanceRef.current; map.locate({ setView: true, maxZoom: 14 }); map.on('locationfound', (e) => { L.circle(e.latlng, { radius: e.accuracy/2, color: 'blue', fillColor: '#3b82f6', fillOpacity: 0.2 }).addTo(routeLayerGroupRef.current); L.circleMarker(e.latlng, { radius: 6, color: 'white', fillColor: '#2563eb', fillOpacity: 1 }).addTo(routeLayerGroupRef.current).bindPopup("í˜„ì¬ ìœ„ì¹˜").openPopup(); }); };
            const locateUserInPopup = () => { if (!popupMapInstanceRef.current) return; const map = popupMapInstanceRef.current; map.locate({ setView: true, maxZoom: 14 }); };

            const isWeatherBad = (dayIndex) => {
                if (!weather || !weather.daily) return false;
                const weatherCode = weather.daily.weather_code[dayIndex - 1];
                return weatherCode > 50; 
            };

            const travelStyle = getTravelStyle();

            return (
                <div className="font-sans bg-slate-50 text-slate-700 min-h-screen pb-24 print:pb-0 print:bg-white">
                    {toastMsg && <Toast message={toastMsg} onClose={() => setToastMsg(null)} />}
                    
                    {isResetMenuOpen && (
                        <div className="fixed inset-0 z-[3000] bg-black/60 flex items-center justify-center p-4 animate-fadeIn" onClick={() => setIsResetMenuOpen(false)}>
                            <div className="bg-white rounded-2xl p-5 w-full max-w-sm shadow-2xl space-y-3" onClick={e => e.stopPropagation()}>
                                <h3 className="text-lg font-black text-slate-800 mb-2">ì´ˆê¸°í™” ì˜µì…˜ ì„ íƒ</h3>
                                <p className="text-sm text-slate-500 mb-4">ì–´ë–¤ ë°ì´í„°ë¥¼ ë³µêµ¬í• ê¹Œìš”?</p>
                                
                                <button onClick={() => handleSelectReset('all')} className="w-full p-4 bg-red-50 text-red-700 font-bold rounded-xl flex items-center gap-3 border border-red-100 hover:bg-red-100">
                                    <Icon name="rotate-ccw" size={20}/> ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™” (Reset All)
                                </button>
                                <button onClick={() => handleSelectReset('day1')} className="w-full p-4 bg-slate-50 text-slate-700 font-bold rounded-xl flex items-center gap-3 border border-slate-100 hover:bg-slate-100">
                                    <Icon name="calendar" size={20}/> 1ì¼ì°¨ ì¼ì •ë§Œ ë³µêµ¬
                                </button>
                                <button onClick={() => handleSelectReset('day2')} className="w-full p-4 bg-slate-50 text-slate-700 font-bold rounded-xl flex items-center gap-3 border border-slate-100 hover:bg-slate-100">
                                    <Icon name="calendar" size={20}/> 2ì¼ì°¨ ì¼ì •ë§Œ ë³µêµ¬
                                </button>
				                <button onClick={() => handleSelectReset('place')} className="w-full p-4 bg-slate-50 text-slate-700 font-bold rounded-xl flex items-center gap-3 border border-slate-100 hover:bg-slate-100">
                                    <Icon name="map-pin" size={20}/> í”Œë ˆì´ìŠ¤ë§Œ ì´ˆê¸°í™”
                                </button>
                                <button onClick={() => handleSelectReset('cost')} className="w-full p-4 bg-green-50 text-green-700 font-bold rounded-xl flex items-center gap-3 border border-green-100 hover:bg-green-100">
                                    <Icon name="dollar-sign" size={20}/> ê²½ë¹„ ë‚´ì—­ë§Œ ì´ˆê¸°í™”
                                </button>
                                
                                <button onClick={() => setIsResetMenuOpen(false)} className="w-full mt-2 py-3 text-slate-400 font-bold text-sm">ì·¨ì†Œ</button>
                            </div>
                        </div>
                    )}

                    <div className="fixed top-0 left-0 right-0 h-[35vh] z-0 shadow-lg no-print">
                        <div ref={mapRef} className="w-full h-full bg-slate-200" />
                        <div className="absolute top-0 left-0 w-full p-4 flex flex-col justify-between pointer-events-none z-[500] h-full">
                            <div className="flex justify-between items-start">
                                <div className="pointer-events-auto">
                                    <span className="inline-block bg-amber-500 text-white text-xs font-black px-3 py-1 rounded-full shadow-md mb-1 animate-bounce">{getDDay()}</span>
                                </div>
                                <div className={`pointer-events-auto bg-white/95 backdrop-blur-md rounded-2xl shadow-xl border border-white/50 text-right transition-all duration-300 relative overflow-hidden ${isWeatherVisible ? 'p-3 min-w-[140px]' : 'p-0 w-10 h-10 flex items-center justify-center'}`}>
                                    <button 
                                        onClick={() => setIsWeatherVisible(!isWeatherVisible)}
                                        className={`${isWeatherVisible ? 'absolute top-2 left-2' : ''} text-slate-400 hover:text-teal-600 transition-colors z-10`}
                                        title={isWeatherVisible ? "ë‚ ì”¨ ìˆ¨ê¸°ê¸°" : "ë‚ ì”¨ ë³´ê¸°"}
                                    >
                                        <Icon name={isWeatherVisible ? "eye-off" : "sun"} size={isWeatherVisible ? 14 : 20} className={!isWeatherVisible ? 'text-amber-500' : ''} />
                                    </button>

                                    {isWeatherVisible && (
                                        weather && weather.current ? (
                                            <div className="animate-fadeIn">
                                                <div className="text-teal-700 font-black text-xl flex items-center justify-end gap-2 mb-1">
                                                    {getWeatherIcon(weather.current.weather_code)} {Math.round(weather.current.temperature_2m)}Â°
                                                </div>
                                                <div className="text-[10px] font-bold text-slate-500 flex justify-end gap-2 border-b border-slate-200 pb-2 mb-2">
                                                    <span className="flex items-center gap-1"><Icon name="droplets" size={10}/> {weather.current.relative_humidity_2m}%</span>
                                                    <span className="flex items-center gap-1"><Icon name="wind" size={10}/> {weather.current.wind_speed_10m}m/s</span>
                                                </div>
                                                <div className="text-right text-xs text-slate-400">ì„œê·€í¬ì‹œ ê¸°ì¤€</div>
                                                <div className="flex justify-between items-center border-b border-slate-200 pb-1 gap-3">
                                                    <span className="text-[11px] font-bold text-slate-500">11.27(ëª©)</span>
                                                    <div className="flex items-center gap-1 text-xs font-bold text-slate-700">
                                                        {getWeatherIcon(weather.daily.weather_code[0])}
                                                        <span>{Math.round(weather.daily.temperature_2m_min[0])}Â°/{Math.round(weather.daily.temperature_2m_max[0])}Â°</span>
                                                    </div>
                                                </div>
                                                <div className="flex justify-between items-center gap-3">
                                                    <span className="text-[11px] font-bold text-slate-500">11.28(ê¸ˆ)</span>
                                                    <div className="flex items-center gap-1 text-xs font-bold text-slate-700">
                                                        {getWeatherIcon(weather.daily.weather_code[1])}
                                                        <span>{Math.round(weather.daily.temperature_2m_min[1])}Â°/{Math.round(weather.daily.temperature_2m_max[1])}Â°</span>
                                                    </div>
                                                </div>
                                            </div>
                                        ) : <div className="text-xs text-slate-400 font-bold mt-6 text-center">ë¡œë”©ì¤‘...</div>
                                    )}
                                </div>
                            </div>
                            <div className="flex justify-end items-end gap-2 pointer-events-auto pb-4">
                                <button onClick={locateUser} className="bg-white p-3 rounded-full shadow-lg text-slate-600 hover:text-blue-600 transition-colors border border-slate-100"><Icon name="crosshair" size={20} /></button>
                            </div>
                        </div>
                    </div>

                    <div className="relative z-10 mt-[32vh] bg-slate-50 min-h-[70vh] rounded-t-[24px] shadow-[0_-5px_20px_rgba(0,0,0,0.1)] px-5 pt-6 pb-24 schedule-container print:mt-0 print:shadow-none print:bg-white">
                        
                        <div className="sticky top-0 z-[100] bg-white/95 backdrop-blur-lg p-2 rounded-2xl shadow-lg border border-teal-100 mb-6 -mx-1 no-print">
                            <div className="flex justify-between items-end mb-2">
                                <div>
                                    <div className="flex items-center gap-2 text-[10px] font-bold text-slate-500 mb-1">
                                        <span className="bg-teal-100 text-teal-700 px-2 py-0.5 rounded-full">Total</span>
                                        <span>ì´ë™ê±°ë¦¬: {Math.round(scheduleData.reduce((acc, cur) => acc + (parseFloat(cur.dist) || 0), 0) * 100) / 100}km</span>
                                        <span>â€¢</span>
                                        <span>ì¥ì†Œ: {scheduleData.filter(s => s.type === 'tour' || s.type === 'cafe' || s.type === 'meal').length}ê³³</span>
                                    </div>
                                    <div className="text-lg font-black text-slate-800 mt-1 truncate w-[200px]">
                                        {activeScheduleItem ? `ğŸš© ${activeScheduleItem.title}` : "ì—¬í–‰ ì¤€ë¹„ ì¤‘..."}
                                    </div>
                                </div>
                                <div className="text-right">
                                    <span className="text-3xl font-black text-teal-600">{Math.round(tripProgress)}<span className="text-base text-teal-400">%</span></span>
                                </div>
                            </div>
                            <div className="w-full h-3 bg-slate-100 rounded-full overflow-hidden shadow-inner relative">
                                <div className="h-full rounded-full transition-all duration-500 ease-out progress-bar-animated relative" style={{ width: `${tripProgress}%` }}>
                                    <div className="absolute right-0 top-0 bottom-0 w-1 bg-white/50 shadow-[0_0_10px_rgba(255,255,255,0.8)]"></div>
                                </div>
                            </div>
                            <div className="flex justify-between mt-1 text-[10px] font-bold text-slate-400">
                                <span>ëŒ€ì „ ì¶œë°œ</span>
                                <span>ì§‘ ë„ì°©</span>
                            </div>
                        </div>

                        {activeTab === 'timeline' && (
                            <div className="flex gap-2 mb-2 no-print">
                                <div className="flex-1 bg-gradient-to-r from-indigo-500 to-purple-600 p-2 rounded-2xl shadow-lg flex justify-between items-center text-white cursor-pointer hover:scale-[1.02] transition-transform" onClick={exportToCalendar}>
                                    <div>
                                        <div className="text-[10px] font-medium opacity-80 mb-1">Calendar</div>
                                        <div className="font-bold flex items-center gap-1 text-sm"><Icon name="calendar" size={16}/> ìº˜ë¦°ë” ë‚´ë³´ë‚´ê¸°</div>
                                    </div>
                                </div>
                                <div className="flex-1 bg-gradient-to-r from-teal-500 to-emerald-600 p-2 rounded-2xl shadow-lg flex justify-between items-center text-white cursor-pointer hover:scale-[1.02] transition-transform" onClick={handlePrint}>
                                    <div>
                                        <div className="text-[10px] font-medium opacity-80 mb-1">Memory</div>
                                        <div className="font-bold flex items-center gap-1 text-sm"><Icon name="printer" size={16}/> PDF/ì¶”ì–µ ì €ì¥</div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'timeline' && (
                            <div className="space-y-8 animate-fadeIn">
                                {[0, 1, 2].map(day => (
                                    <div key={day} className="timeline-group">
                                        <div className="sticky top-[105px] bg-slate-50/95 backdrop-blur-sm py-3 z-20 border-b-2 border-teal-600 flex justify-between items-end mb-4 print:static print:bg-white print:border-b-black">
                                            <div>
                                                <h2 className="text-lg font-black text-slate-800">{day === 0 ? 'Day 0 (ì¤€ë¹„)' : `Day ${day} ${day===1?'(ì„œìª½)':'(ë™ìª½)'}`}</h2>
                                                <span className="text-xs font-bold text-slate-400">{day===1?'11.27(ëª©)':(day===2?'11.28(ê¸ˆ)':'11.26(ìˆ˜)')}</span>
                                            </div>
                                            {day > 0 && (
                                                <div className="text-[10px] font-bold text-slate-500 text-right">
                                                    <div>{Math.round(scheduleData.filter(s => s.day === day).reduce((acc, cur) => acc + (parseFloat(cur.dist) || 0), 0) * 100) / 100}km ì´ë™</div>
                                                    <div>{scheduleData.filter(s => s.day === day && (s.type === 'tour' || s.type === 'cafe')).length}ê³³ ë°©ë¬¸</div>
                                                </div>
                                            )}
                                        </div>
                                        <div className="space-y-0">
                                            {scheduleData.filter(s => s.day === day).map((item, index, array) => {
                                                const isActive = activeScheduleItem && activeScheduleItem.id === item.id;
                                                const isStamped = visitedPlaces.includes(item.id);
                                                const itemTime = getItemDate(item.day, item.time);
                                                const nextItem = array[index + 1];
                                                const nextItemTime = nextItem ? getItemDate(nextItem.day, nextItem.time) : (itemTime ? new Date(itemTime.getTime() + 60*60*1000) : null);
                                                let lineStatus = 'future';
                                                if (currentTime && nextItemTime) {
                                                    if (currentTime >= nextItemTime) lineStatus = 'past';
                                                    else if (currentTime >= itemTime && currentTime < nextItemTime) lineStatus = 'current';
                                                }
                                                const showWeatherAlert = (item.day > 0 && isWeatherBad(item.day) && (item.type === 'tour' || item.type === 'cafe'));

                                                return (
                                                <div key={item.id} id={`item-${item.id}`} className="timeline-item">
                                                    {item.dist && item.dist !== '-' && (
                                                        <div className="flex items-center gap-2 text-[11px] font-bold text-slate-500 bg-slate-100 px-3 py-1 rounded-full w-fit mb-3 ml-14 border border-slate-200 no-print">
                                                            <Icon name="car" size={12} className="text-slate-400" />
                                                            <span>{item.dist}</span>
                                                            <span className="text-slate-300">|</span>
                                                            <span>{item.dur}</span>
                                                        </div>
                                                    )}
                                                    
                                                    <div className="flex w-full relative pb-6 last:pb-0 group cursor-pointer" onClick={() => openMapPopup(item)}>
                                                        <div className="w-14 text-right pr-3 flex-shrink-0 pt-0.5 timeline-time">
                                                            <span className={`text-sm font-black font-mono ${isActive ? 'text-red-500' : 'text-slate-700'}`}>{item.time}</span>
                                                        </div>
                                                        <div className="w-6 flex flex-col items-center relative timeline-line">
                                                            <div className={`w-3.5 h-3.5 rounded-full border-[3px] z-10 bg-slate-200 border-white shadow-sm ring-1 ring-slate-200 group-hover:bg-teal-500 group-hover:ring-teal-500 transition-colors 
                                                                ${item.isSpecial ? 'ring-purple-400 bg-purple-100' : ''} 
                                                                ${isStamped ? 'bg-amber-400 ring-amber-400' : (isActive ? 'bg-red-500 ring-red-500 scale-125 shadow-[0_0_10px_rgba(239,68,68,0.6)]' : (lineStatus === 'past' ? (item.day === 2 ? 'bg-orange-500 ring-orange-500' : 'bg-teal-500 ring-teal-500') : ''))}`} />
                                                            
                                                            <div className={`w-1 flex-grow my-1 rounded-full transition-all duration-500
                                                                ${lineStatus === 'past' ? (item.day === 2 ? 'bg-orange-500' : 'bg-teal-500') : 
                                                                  lineStatus === 'current' ? (item.day === 2 ? 'bg-gradient-to-b from-orange-500 via-orange-300 to-slate-200' : 'bg-gradient-to-b from-teal-500 via-teal-300 to-slate-200') : 'bg-slate-200'}`} />
                                                        </div>
                                                        <div className="flex-1 pl-3 pb-2 timeline-content min-w-0">
                                                            <div className={`bg-white border border-slate-200 rounded-2xl p-4 shadow-sm group-hover:shadow-md group-hover:border-teal-200 transition-all active:scale-98 relative overflow-hidden 
                                                                ${item.isSpecial ? 'border-purple-200 bg-purple-50' : ''} 
                                                                ${isActive ? 'active-card' : ''}
                                                                ${isStamped ? 'stamped-card' : ''}`}>
                                                                
                                                                {isActive && <div className="absolute top-0 right-0 bg-red-500 text-white text-[10px] font-bold px-2 py-1 rounded-bl-lg animate-pulse no-print">ì§„í–‰ì¤‘</div>}
                                                                {isStamped && <div className="absolute top-2 right-2 text-amber-500 stamp-mark opacity-30"><Icon name="award" size={48} strokeWidth={1.5} /></div>}
                                                                {showWeatherAlert && !isStamped && <div className="absolute top-0 right-0 bg-blue-500 text-white text-[10px] font-bold px-2 py-1 rounded-bl-lg no-print z-10">â˜” ìš°ì²œ ëŒ€ë¹„</div>}

                                                                <div className="flex justify-between items-start mb-1">
                                                                    <h3 className="font-black text-slate-800 flex items-center gap-2 truncate pr-12">
                                                                        {item.title}
                                                                        {item.isDrive && <span className="text-[10px] bg-cyan-100 text-cyan-700 px-1.5 py-0.5 rounded font-bold flex-shrink-0 ml-1 no-print">ë“œë¼ì´ë¸Œ</span>}
                                                                    </h3>
                                                                    <div className="p-1.5 rounded-full bg-slate-100 text-slate-400 flex-shrink-0 no-print">{getTypeIcon(item.type)}</div>
                                                                </div>
                                                                <p className="text-sm text-slate-600 mb-2 leading-relaxed line-clamp-2">{item.desc}</p>
                                                                
                                                                {item.detail && <div className="bg-blue-50 border-l-2 border-blue-500 p-2 rounded-r-lg text-xs text-blue-800 leading-relaxed mt-2"><span className="font-bold mr-1">Tip:</span>{item.detail}</div>}
                                                                
                                                                {item.type === 'flight' && item.flightNum && (
                                                                    <button onClick={(e) => { e.stopPropagation(); openFlightSearch(item.flightNum); }} className="w-full mt-3 bg-sky-100 text-sky-700 py-2 rounded-lg text-xs font-bold flex items-center justify-center gap-2 hover:bg-sky-200 no-print"><Icon name="plane" size={14}/> {item.flightNum} ì‹¤ì‹œê°„ ìš´í•­ì •ë³´ í™•ì¸</button>
                                                                )}

                                                                {(item.type === 'meal' || item.type === 'cafe' || item.type === 'tour') && (
                                                                    <div className="mt-3 pt-3 border-t border-slate-100">
                                                                        <input 
                                                                            type="file" 
                                                                            accept="image/*" 
                                                                            className="hidden" 
                                                                            ref={el => fileInputRefs.current[item.id] = el}
                                                                            onChange={(e) => handlePhotoUpload(e, item.id)}
                                                                        />
                                                                        <div className="flex gap-2 items-center overflow-x-auto no-scrollbar pb-1 no-print">
                                                                            <button onClick={(e) => { e.stopPropagation(); fileInputRefs.current[item.id].click(); }} className="flex-shrink-0 flex items-center gap-1 bg-slate-50 text-slate-500 border border-slate-200 text-[10px] px-2 py-1.5 rounded hover:bg-slate-100 transition-colors">
                                                                                <Icon name="camera" size={12} /> {photoLogs[item.id] ? 'ì‚¬ì§„ ë³€ê²½' : 'ì‚¬ì§„ ì¶”ê°€'}
                                                                            </button>
                                                                            <button onClick={(e) => { e.stopPropagation(); shareLocation(item); }} className="flex-shrink-0 flex items-center gap-1 bg-yellow-50 text-yellow-700 border border-yellow-200 text-[10px] px-2 py-1.5 rounded hover:bg-yellow-100">
                                                                                <Icon name="share-2" size={12} /> ì¹´í†¡ ê³µìœ 
                                                                            </button>
                                                                            <button onClick={(e) => { e.stopPropagation(); openNearbySearch('', 'í¸ì˜ì '); }} className="flex-shrink-0 flex items-center gap-1 bg-blue-50 text-blue-600 border border-blue-100 text-[10px] px-2 py-1.5 rounded hover:bg-blue-100">
                                                                                <Icon name="store" size={12} /> í¸ì˜ì 
                                                                            </button>
                                                                            <button onClick={(e) => { e.stopPropagation(); openNearbySearch('', 'ì£¼ìœ ì†Œ'); }} className="flex-shrink-0 flex items-center gap-1 bg-green-50 text-green-600 border border-green-100 text-[10px] px-2 py-1.5 rounded hover:bg-green-100">
                                                                                <Icon name="fuel" size={12} /> ì£¼ìœ ì†Œ
                                                                            </button>
                                                                        </div>
                                                                        
                                                                        {photoLogs[item.id] && (
                                                                            <div className="mt-2 relative group/img">
                                                                                <img src={photoLogs[item.id]} alt="Travel Log" className="w-full h-40 object-cover rounded-lg shadow-sm" />
                                                                                <div className="absolute bottom-1 right-1 bg-black/50 text-white text-[10px] px-2 py-1 rounded-full backdrop-blur-sm no-print">My Memory</div>
                                                                                <button 
                                                                                    onClick={(e) => handlePhotoDelete(e, item.id)}
                                                                                    className="absolute top-2 right-2 bg-red-500/90 text-white p-1.5 rounded-full shadow-md hover:bg-red-600 transition-colors no-print"
                                                                                    title="ì‚¬ì§„ ì‚­ì œ"
                                                                                >
                                                                                    <Icon name="trash-2" size={14} />
                                                                                </button>
                                                                            </div>
                                                                        )}

                                                                        <textarea 
                                                                            className="w-full mt-2 p-2 text-sm bg-amber-50/50 border border-amber-100 rounded-lg focus:ring-2 focus:ring-amber-200 focus:border-amber-300 outline-none placeholder-slate-400 transition-all print:bg-white print:border-none print:p-0"
                                                                            rows={photoLogs[item.id] ? 2 : 1}
                                                                            placeholder="ì´ê³³ì— ì—¬í–‰ ë©”ëª¨ë¥¼ ë‚¨ê²¨ë³´ì„¸ìš”"
                                                                            value={memoState[item.id] || ''}
                                                                            onChange={(e) => handleMemoChange(item.id, e.target.value)}
                                                                            onClick={(e) => e.stopPropagation()}
                                                                        />
                                                                    </div>
                                                                )}

                                                                {item.alternatives && (
                                                                    <div className="mt-3 space-y-2 no-print">
                                                                        {item.alternatives.map((alt, idx) => (
                                                                            <div key={idx} className="bg-slate-50 p-3 rounded-xl border border-slate-200 hover:bg-slate-100 transition-colors" onClick={(e) => { e.stopPropagation(); openNavi(alt.navi); }}>
                                                                                <div className="flex items-center gap-2 text-xs font-black text-slate-700 mb-1"><Icon name="corner-down-right" size={12} className="text-amber-500" /> {alt.name}</div>
                                                                                <div className="text-xs text-slate-500 pl-5">{alt.desc}</div>
                                                                            </div>
                                                                        ))}
                                                                    </div>
                                                                )}
                                                                <div className="flex gap-2 mt-3 flex-wrap no-print">
                                                                    {item.navi && <button onClick={(e) => { e.stopPropagation(); openNavi(item.navi); }} className="flex items-center gap-1 bg-teal-700 text-white text-xs px-3 py-2 rounded-lg font-bold shadow-sm active:bg-teal-800 hover:bg-teal-600 whitespace-nowrap"><Icon name="navigation" size={12} /> ê¸¸ì°¾ê¸°</button>}
                                                                    {item.lat && <button onClick={(e) => { e.stopPropagation(); openMapPopup(item); }} className="flex items-center gap-1 bg-slate-100 text-slate-600 text-xs px-3 py-2 rounded-lg font-bold shadow-sm hover:bg-slate-200 whitespace-nowrap"><Icon name="map" size={12} /> ì§€ë„</button>}
                                                                    {item.day > 0 && (
                                                                        <button onClick={(e) => toggleStamp(e, item.id)} className={`flex items-center gap-1 text-xs px-3 py-2 rounded-lg font-bold shadow-sm transition-colors whitespace-nowrap ${isStamped ? 'bg-amber-100 text-amber-700 border border-amber-200' : 'bg-white border border-slate-200 text-slate-500 hover:bg-slate-50'}`}>
                                                                            <Icon name={isStamped ? "check-circle" : "circle"} size={12} /> {isStamped ? "ì™„ë£Œ" : "ì¸ì¦"}
                                                                        </button>
                                                                    )}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            )})}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {activeTab === 'places' && (
                            <div className="space-y-4 animate-fadeIn">
                                {placesData.map((place, idx) => (
                                    <div key={idx} className="bg-white border border-slate-200 rounded-2xl p-5 shadow-sm">
                                        <div className="flex justify-between items-start mb-3">
                                            <div>
                                                <span className={`inline-block text-[10px] font-bold px-2 py-0.5 rounded mb-1 ${place.type === 'meal' ? 'bg-orange-100 text-orange-700' : (place.type === 'cafe' ? 'bg-purple-100 text-purple-700' : 'bg-green-100 text-green-700')}`}>{place.type === 'meal' ? 'ë§›ì§‘' : (place.type === 'cafe' ? 'ì¹´í˜' : 'ê´€ê´‘ì§€')}</span>
                                                <h3 className="text-lg font-black text-slate-800">{place.name}</h3>
                                            </div>
                                            <button onClick={() => openNavi(place.name)} className="text-slate-400 hover:text-teal-600"><Icon name="navigation" size={20} /></button>
                                        </div>
                                        <div className="text-sm mb-3"><span className="font-bold text-teal-700">â˜… ëŒ€í‘œë©”ë‰´:</span> {place.main}</div>
                                        <p className="text-sm text-slate-600 mb-4 bg-slate-50 p-3 rounded-lg leading-relaxed">{place.desc}</p>
                                        <div>
                                            <div className="text-xs font-bold text-amber-600 mb-2 flex items-center gap-1"><Icon name="info" size={12} /> ì „ë¬¸ê°€ Tip</div>
                                            <ul className="space-y-1">{place.tips.map((tip, i) => (<li key={i} className="text-xs text-slate-500 pl-3 relative before:content-['â€¢'] before:absolute before:left-0 before:text-slate-300">{tip}</li>))}</ul>
                                        </div>
                                        <div className="flex gap-2 mt-4">
                                            <a href={`https://search.naver.com/search.naver?where=blog&query=${encodeURIComponent("ì œì£¼ "+place.name+" ì†”ì§í›„ê¸°")}`} target="_blank" className="flex-1 py-3 rounded-xl border border-slate-200 flex items-center justify-center gap-2 text-sm font-bold text-slate-600 bg-white hover:bg-slate-50"><Icon name="search" size={16} /> ì†”ì§ í›„ê¸°</a>
                                            <a href={`https://m.search.naver.com/search.naver?query=${encodeURIComponent("ì œì£¼ "+place.name)}`} target="_blank" className="flex-1 py-3 rounded-xl flex items-center justify-center gap-2 text-sm font-bold text-white bg-green-500 hover:bg-green-600 shadow-sm"><Icon name="book-open" size={16} />ì •ë³´</a>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {activeTab === 'tips' && (
                            <div className="space-y-4 animate-fadeIn">
                                {/* [ì‹ ê·œ ê¸°ëŠ¥] ì—¬í–‰ ìŠ¤íƒ€ì¼ ë¶„ì„ ì¹´ë“œ */}
                                <div className={`border border-slate-100 rounded-2xl p-5 shadow-sm mb-4 ${travelStyle.bg}`}>
                                    <div className="flex items-center gap-3 mb-2">
                                        <div className="bg-white p-2 rounded-full shadow-sm"><Icon name={travelStyle.icon} size={20} className={travelStyle.color}/></div>
                                        <div>
                                            <div className="text-xs font-bold text-slate-500 mb-0.5">ë‚˜ì˜ ì—¬í–‰ DNA ë¶„ì„</div>
                                            <div className="text-lg font-black text-slate-800">{travelStyle.title}</div>
                                        </div>
                                    </div>
                                    <p className="text-sm text-slate-600 pl-2 border-l-2 border-white/50">{travelStyle.desc}</p>
                                </div>

                                {GUIDES.map((g, i) => (
                                    <div key={i} className="bg-white border border-slate-200 rounded-xl overflow-hidden shadow-sm">
                                        <div className="p-4 bg-white flex items-center gap-3">
                                            <div className={`${g.color} opacity-80`}><Icon name={g.icon} size={20}/></div>
                                            <span className="font-black text-slate-800 text-sm">{g.title}</span>
                                        </div>
                                        <div className="px-4 pb-4 bg-slate-50 border-t border-slate-100 text-sm text-slate-600 leading-relaxed">
                                            <ul className="space-y-2 mt-3">{g.content.map((line, k) => <li key={k} className="pl-3 relative before:content-['â€¢'] before:absolute before:left-0 before:text-teal-500 before:font-bold">{line}</li>)}</ul>
                                            {g.id === 'g0' && (
                                                <div className="mt-3 grid grid-cols-2 gap-2">
                                                    <button onClick={()=>openNearbySearch("", "ì‘ê¸‰ì‹¤")} className="bg-red-50 text-red-600 py-2 rounded font-bold text-xs hover:bg-red-100">ğŸ¥ ê°€ê¹Œìš´ ì‘ê¸‰ì‹¤ ì°¾ê¸°</button>
                                                    <button onClick={()=>openNearbySearch("", "ì£¼ìœ ì†Œ")} className="bg-green-50 text-green-600 py-2 rounded font-bold text-xs hover:bg-green-100">â›½ ì£¼ë³€ ì£¼ìœ ì†Œ ì°¾ê¸°</button>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {activeTab === 'cost' && (
                            <div className="space-y-6 animate-fadeIn">
                                <div className="bg-white border border-slate-200 rounded-2xl p-5 shadow-sm">
                                    <h3 className="text-lg font-black text-slate-800 mb-4 flex items-center gap-2"><Icon name="pie-chart" size={20} className="text-teal-600"/> ì§€ì¶œ ë¶„ì„</h3>
                                    <div className="flex items-center justify-center gap-6">
                                        <div className="relative w-32 h-32 rounded-full flex items-center justify-center shadow-inner" style={{ background: `conic-gradient(#3b82f6 0deg ${c1Deg}deg, #f97316 ${c1Deg}deg ${c1Deg + c2Deg}deg, #22c55e ${c1Deg + c2Deg}deg 360deg)` }}>
                                            <div className="absolute inset-2 bg-white rounded-full flex flex-col items-center justify-center">
                                                <span className="text-xs text-slate-400 font-bold">ì§€ì¶œìœ¨</span>
                                                <span className="text-xl font-black text-slate-800">{spentPercent}%</span>
                                            </div>
                                        </div>
                                        <div className="space-y-2 text-xs font-bold text-slate-600">
                                            <div className="flex items-center gap-2"><span className="w-3 h-3 rounded-full bg-blue-500"></span>êµí†µ/ìˆ™ë°• ({Math.round(costSummary.totalSpent ? (costSummary.c1/costSummary.totalSpent)*100 : 0)}%)</div>
                                            <div className="flex items-center gap-2"><span className="w-3 h-3 rounded-full bg-orange-500"></span>ì‹ë¹„ ({Math.round(costSummary.totalSpent ? (costSummary.c2/costSummary.totalSpent)*100 : 0)}%)</div>
                                            <div className="flex items-center gap-2"><span className="w-3 h-3 rounded-full bg-green-500"></span>ì‡¼í•‘/ê¸°íƒ€ ({Math.round(costSummary.totalSpent ? (costSummary.c3/costSummary.totalSpent)*100 : 0)}%)</div>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-gradient-to-r from-slate-700 to-slate-800 rounded-2xl p-5 shadow-md text-white">
                                    <h3 className="text-sm font-bold mb-3 flex items-center gap-2 text-slate-200"><Icon name="database" size={16} /> ë°ì´í„° ì•ˆì „ ë³´ê´€í•¨</h3>
                                    <div className="flex gap-2">
                                        <button onClick={backupData} className="flex-1 bg-white/10 hover:bg-white/20 transition-colors border border-white/20 py-3 rounded-xl flex flex-col items-center justify-center gap-1">
                                            <Icon name="download" size={20} className="text-teal-300"/>
                                            <span className="text-xs font-bold">ë°±ì—… íŒŒì¼ ì €ì¥</span>
                                        </button>
                                        <div className="flex-1 relative">
                                            <input type="file" ref={restoreInputRef} onChange={restoreData} accept=".json" className="hidden" />
                                            <button onClick={() => restoreInputRef.current.click()} className="w-full h-full bg-white/10 hover:bg-white/20 transition-colors border border-white/20 py-3 rounded-xl flex flex-col items-center justify-center gap-1">
                                                <Icon name="upload" size={20} className="text-orange-300"/>
                                                <span className="text-xs font-bold">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-white border border-slate-200 rounded-2xl p-5 shadow-sm">
                                    <h3 className="text-lg font-black text-indigo-800 mb-4 flex items-center gap-2"><Icon name="check-square" size={20} /> ì—¬í–‰ ì¤€ë¹„ë¬¼ ì²´í¬ë¦¬ìŠ¤íŠ¸</h3>
                                    <div className="grid grid-cols-2 gap-3">
                                        {CHECKLIST.map((item, idx) => (
                                            <div key={idx} onClick={() => toggleChecklist(item)} className={`flex items-center gap-2 p-3 rounded-xl cursor-pointer transition-colors ${checklistState[item] ? 'bg-indigo-50 text-indigo-700' : 'bg-slate-50 text-slate-500'}`}>
                                                <Icon name={checklistState[item] ? "check-square" : "square"} size={18} className={checklistState[item] ? "text-indigo-600" : "text-slate-300"} />
                                                <span className={`text-xs font-bold ${checklistState[item] ? 'line-through opacity-70' : ''}`}>{item}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                <div className="bg-white border border-slate-200 rounded-2xl p-5 shadow-sm">
                                    <h3 className="text-lg font-black text-teal-800 mb-4 flex items-center gap-2"><Icon name="dollar-sign" size={20} /> ì‹¤ì‹œê°„ ì—¬í–‰ ê°€ê³„ë¶€</h3>
                                    {costData.map((group, idx) => {
                                        const subTotal = group.items.reduce((sum, item) => sum + item.v, 0);
                                        const perPerson = Math.round(subTotal / 3);
                                        const borderClass = idx === 0 ? 'border-l-4 border-l-blue-500' : (idx === 1 ? 'border-l-4 border-l-orange-500' : 'border-l-4 border-l-green-500');
                                        const titleColor = idx === 0 ? 'text-blue-600' : (idx === 1 ? 'text-orange-600' : 'text-green-600');

                                        return (
                                        <div key={idx} className={`mb-5 last:mb-0 bg-slate-50/50 p-4 rounded-xl shadow-sm ${borderClass}`}>
                                            <div className={`text-xs font-black ${titleColor} mb-3 uppercase tracking-wider border-b border-slate-200 pb-2 flex justify-between items-center`}>
                                                <span>{group.cat}</span>
                                                <span className="bg-white px-2 py-0.5 rounded shadow-sm text-[10px] text-slate-400">3ì¸ ê¸°ì¤€</span>
                                            </div>
                                            <div className="space-y-3">
                                                {group.items.map((item, i) => {
                                                    const spent = actualCosts[item.id] || 0;
                                                    const diff = item.v - spent;
                                                    return (
                                                    <div key={i} className="bg-white p-2 rounded-lg border border-slate-100">
                                                        <div className="flex justify-between text-sm text-slate-600 mb-1">
                                                            <span className="font-bold">{item.n}</span>
                                                            <span className="text-xs text-slate-400">ì˜ˆì‚°: {formatCost(item.v)}</span>
                                                        </div>
                                                        <div className="flex items-center gap-2">
                                                            <input type="text" placeholder="ì‹¤ì œ ì§€ì¶œ ì…ë ¥" 
                                                                className="flex-1 bg-slate-50 border border-slate-200 rounded px-2 py-1 text-sm text-right font-bold focus:border-teal-500 outline-none"
                                                                value={actualCosts[item.id] || ''}
                                                                onChange={(e) => handleCostChange(item.id, e.target.value)}
                                                            />
                                                            <span className="text-xs font-bold w-16 text-right">
                                                                {spent > 0 ? (diff >= 0 ? <span className="text-blue-600">+{formatCost(diff)}</span> : <span className="text-red-500">{formatCost(diff)}</span>) : '-'}
                                                            </span>
                                                        </div>
                                                    </div>
                                                )})}
                                            </div>
                                            <div className="mt-3 pt-2 border-t border-slate-200 flex justify-between items-end">
                                                <span className="text-xs font-bold text-slate-500">ì¹´í…Œê³ ë¦¬ ì†Œê³„</span>
                                                <div className="text-right">
                                                    <span className="block text-sm font-black text-slate-700">{formatCost(subTotal)}ì›</span>
                                                    <span className="text-[10px] font-bold text-slate-400 bg-white px-1 rounded border border-slate-100">1ì¸ë‹¹ {formatCost(perPerson)}ì›</span>
                                                </div>
                                            </div>
                                        </div>
                                    )})}
                                    
                                    <div className="bg-teal-50 p-4 rounded-xl mt-4 border border-teal-100">
                                        <div className="flex justify-between items-center mb-2">
                                            <span className="font-bold text-teal-800">ì´ ì˜ˆì‚° í•©ê³„</span>
                                            <span className="font-black text-teal-700 text-lg">{formatCost(costData.reduce((acc, grp) => acc + grp.items.reduce((s, i) => s + i.v, 0), 0))}ì›</span>
                                        </div>
                                        <div className="flex justify-between items-center mb-2 border-t border-teal-200 pt-2">
                                            <span className="font-bold text-red-600">í˜„ì¬ ì´ ì§€ì¶œ</span>
                                            <div className="text-right">
                                                <span className="block font-black text-red-600">{formatCost(Object.values(actualCosts).reduce((a, b) => a + b, 0))}ì›</span>
                                                <span className="text-[10px] text-red-400 font-bold">(1ì¸ë‹¹: {formatCost(Math.round(Object.values(actualCosts).reduce((a, b) => a + b, 0) / 3))}ì›)</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>

                    <div className="fixed bottom-24 right-5 flex flex-col gap-3 items-end z-50 no-print">
                        {isMusicMenuOpen && (
                            <div className="bg-white rounded-xl shadow-xl p-2 border border-slate-100 flex flex-col gap-2 animate-fadeIn mb-2 w-48">
                                <div className="text-xs font-bold text-slate-400 px-2 py-1">ì œì£¼ ë“œë¼ì´ë¸Œ BGM ğŸµ</div>
                                {MUSIC_LINKS.map((m, i) => (
                                    <a key={i} href={m.url} target="_blank" className="block text-sm font-bold text-slate-700 hover:bg-teal-50 px-3 py-2 rounded-lg transition-colors">
                                        {m.name}
                                    </a>
                                ))}
                            </div>
                        )}
                        <div className="relative">
                            <span className="absolute right-full top-1/2 -translate-y-1/2 mr-3 bg-slate-800 text-white text-[10px] font-bold px-2 py-1 rounded-md opacity-0 hover:opacity-100 transition-opacity whitespace-nowrap">ë“œë¼ì´ë¸Œ BGM</span>
                            <button onClick={() => setIsMusicMenuOpen(!isMusicMenuOpen)} className="bg-white text-pink-500 p-3 rounded-full shadow-lg hover:scale-105 transition-transform border border-pink-100">
                                <Icon name="music" size={24} />
                            </button>
                        </div>
                    </div>

                    <button onClick={() => setIsChatOpen(true)} className="fixed bottom-20 right-5 bg-gradient-to-r from-teal-500 to-emerald-600 text-white p-4 rounded-full shadow-2xl z-50 hover:scale-105 transition-transform flex items-center justify-center border-4 border-white no-print"><Icon name="message-circle" size={28} fill="white" /></button>

                    {isChatOpen && <ChatWidget onClose={() => setIsChatOpen(false)} schedule={scheduleData} places={placesData} costs={costData} onUpdateSchedule={handleUpdateSchedule} onResetSchedule={handleResetSchedule} currentTime={currentTime} />}

                    {isMapPopupOpen && selectedPlace && (
                        <div className="fixed inset-0 z-[1000] bg-black/60 flex items-center justify-center p-4 no-print" onClick={closeMapPopup}>
                            <div className="bg-white w-full max-w-lg rounded-2xl overflow-hidden shadow-2xl" onClick={e=>e.stopPropagation()}>
                                <div className="relative h-[400px]">
                                    <div ref={popupMapRef} className="w-full h-full bg-slate-100"></div>
                                    <button onClick={closeMapPopup} className="absolute top-3 right-3 bg-white p-2 rounded-full shadow-md z-[1001]"><Icon name="x" size={20}/></button>
                                    <button onClick={locateUserInPopup} className="absolute bottom-3 right-3 bg-white p-3 rounded-full shadow-lg z-[1001] text-slate-600 border border-slate-100"><Icon name="crosshair" size={20}/></button>
                                </div>
                                <div className="p-5">
                                    <h3 className="font-black text-lg mb-1">{selectedPlace.title}</h3>
                                    <p className="text-sm text-slate-600 mb-4">{selectedPlace.desc}</p>
                                    <button onClick={()=>openNavi(selectedPlace.navi)} className="w-full bg-teal-600 text-white py-3 rounded-xl font-bold flex justify-center gap-2"><Icon name="navigation" size={18}/> ê¸¸ì°¾ê¸° ì‹œì‘</button>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="fixed bottom-0 left-0 w-full bg-white/95 backdrop-blur-lg border-t border-slate-200 pb-6 pt-2 px-6 flex justify-between items-center z-50 shadow-[0_-4px_10px_rgba(0,0,0,0.05)] no-print">
                        <NavBtn active={activeTab === 'timeline'} onClick={() => setActiveTab('timeline')} icon="clock" label="íƒ€ì„ë¼ì¸" />
                        <NavBtn active={activeTab === 'places'} onClick={() => setActiveTab('places')} icon="map-pin" label="í”Œë ˆì´ìŠ¤" />
                        <NavBtn active={activeTab === 'tips'} onClick={() => setActiveTab('tips')} icon="info" label="ê¿€íŒë°±ê³¼" />
                        <NavBtn active={activeTab === 'cost'} onClick={() => setActiveTab('cost')} icon="dollar-sign" label="ê²½ë¹„/ì²´í¬" />
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>

